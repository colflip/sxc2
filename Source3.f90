

SUBROUTINE Single_Boundry_AziTrak_Invision(RA,GEO,CSZ,RES_RT,RTS,DTBM,FLG_YS,UP_YS,DW_YU,CSZ_TEMP)
!SUBROUTINE Multi_Boundry_Invision_AziTrak(RA,GEO,CSZ,RES_RT,RTS,DTBM,FLG_YS,UP_YS,DW_YU,FILENAME03,LEN2,EFF_CHECK)
!!DEC$ ATTRIBUTES DLLEXPORT :: Multi_Boundry_Invision_AziTrak
USE DB_DATA
IMPLICIT NONE
REAL*8,INTENT(INOUT)::RA(4),GEO(2),CSZ(6)
REAL*8,INTENT(OUT)::RES_RT(4)
REAL*8,INTENT(OUT)::RTS(3),DTBM(2)
INTEGER,INTENT(IN):: FLG_YS(6)
REAL*8,INTENT(IN):: UP_YS(6),DW_YU(6)
!!DEC$ ATTRIBUTES REFERENCE :: RA,GEO,CSZ
!!DEC$ ATTRIBUTES REFERENCE :: RES_RT,RTS,DTBM
!!DEC$ ATTRIBUTES REFERENCE :: FLG_YS,UP_YS,DW_YU

!INTEGER,INTENT(OUT)::EFF_CHECK
!INTEGER,INTENT(IN)::LEN2
!CHARACTER(LEN=LEN2),INTENT(IN) :: FILENAME03
!INTEGER STR_LEN
!!DEC$ ATTRIBUTES VALUE :: LEN2
!!DEC$ ATTRIBUTES REFERENCE :: FILENAME03
!!DEC$ ATTRIBUTES REFERENCE :: EFF_CHECK

!STR_LEN=LEN_TRIM(FILENAME03)
!CALL EFFCHECK(FILENAME03, STR_LEN, EFF_CHECK)
!IF(EFF_CHECK .NE. 0)THEN
!RETURN
!ENDIF

!声明临时变量
REAL*8 CZ(4),RB(5) !输入
REAL*8 RES_FY(4),ERR !输出
REAL*8 TEMP,THICK_LAYER
INTEGER I,J,K
REAL*8 CSZ_TEMP(6),THICK,FY_RES(6),AVER_RA,MIN_RAS,MAX_RAS

!!!!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!!!!正式版注释掉这一段代码 
!CHARACTER*10 DATE,TIME
!INTEGER IALLOC
!CALL DATE_AND_TIME(DATE,TIME)
!READ(DATE,"(I4)")IALLOC
!IF(IALLOC.GT.2025)THEN
!GEO=0.0
!RA=0.1*RA
!ENDIF
!!!!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
THICK_LAYER=CSZ(3)-CSZ(2)
THICK=THICK_LAYER
RTS(1:3)=CSZ(4:6)
DTBM(1:2)=CSZ(2:3)
!赋初值
CZ(1)=CSZ(1)
IF(ABS(CSZ(2)).LE.ABS(CSZ(3)))THEN
CZ(4)=CSZ(2)
ELSE
CZ(4)=CSZ(3)
ENDIF
IF(ABS(CZ(4)-CSZ(2)).LE.1E-6)THEN !上边界
IF(CZ(4).GE.0.0)THEN
CZ(2)=CSZ(5)
CZ(3)=CSZ(4)
ELSE
CZ(2)=CSZ(4)
CZ(3)=CSZ(5)
ENDIF
ELSE  !下边界
IF(CZ(4).GE.0.0)THEN
CZ(2)=CSZ(6)
CZ(3)=CSZ(5)
ELSE
CZ(2)=CSZ(5)
CZ(3)=CSZ(6)
ENDIF
ENDIF

RB(1:4)=RA(1:4)
RB(5)=GEO(1)

IF(FLG_YS(6).EQ.1)THEN !方位约束
IF(GEO(2).LE.UP_YS(6))GEO(2)=UP_YS(6)
IF(GEO(2).GE.DW_YU(6))GEO(2)=DW_YU(6)
ENDIF


IF(RB(1).GE.10.0.AND.RB(5).LE.100.0)RB(5)=100.0+(RB(5)-100.0)/(MAX(RB(1),2.0))
!反演计算 OK1
!IF(GEO(2).GE.5.0.AND.GEO(2).LE.12.0)THEN
CALL INV_AziTrack_LWD_CW(RB,CSZ,RES_RT,FY_RES,ERR,FLG_YS,UP_YS,DW_YU,CSZ_TEMP) !下边界反演
!ELSE
!CALL INV_AziTrack_LWD_CN(RB,CSZ,FY_RES,ERR,FLG_YS,UP_YS,DW_YU,CSZ_TEMP) !上边界反演
!ENDIF
!RES_FY(2)=(RES_FY(2)+CZ(2)*2.0)/3.0

!!反演计算 OK1 待优化
!CALL INV_AziTrack_LWD_CW(RB,CZ,RES_FY,ERR,FLG_YS,UP_YS,DW_YU,CSZ_TEMP) !下边界反演


!结果输出
!RES_RT(1:4)=RES_FY(1:4)
!if(cz(2).gt.cz(3))then
!RES_RT(2)=max(RES_FY(2),RES_FY(3))
!RES_RT(3)=min(RES_FY(2),RES_FY(3))
!else
!RES_RT(2)=min(RES_FY(2),RES_FY(3))
!RES_RT(3)=max(RES_FY(2),RES_FY(3))
!endif
!!结果保存处理 3层
!IF(GEO(2).GE.5.0.AND.GEO(2).LE.12.0)THEN  !下边界
!IF(CSZ(2).GE.0.0)THEN !第一个边界
!RTS(1)=RES_FY(3)
!RTS(2)=RES_FY(2)
!TEMP=CSZ(3)-CSZ(2)
!DTBM(1)=RES_FY(4)
!DTBM(2)=DTBM(1)+TEMP
!ELSEIF(CSZ(3).LT.0.0)THEN !第二个边界
!RTS(2)=RES_FY(3)
!RTS(3)=RES_FY(2)
!TEMP=CSZ(3)-CSZ(2)
!DTBM(2)=RES_FY(4)
!DTBM(1)=DTBM(2)-TEMP
!ENDIF
!ELSE  !上边界
!IF(CSZ(3).GT.0.0)THEN !第一个边界
!RTS(1)=RES_FY(2)
!RTS(2)=RES_FY(3)
!TEMP=CSZ(3)-CSZ(2)
!DTBM(1)=0.0-RES_FY(4)
!DTBM(2)=TEMP+DTBM(1)
!ELSEIF(CSZ(3).LE.0.0)THEN !第二个边界
!RTS(2)=RES_FY(2)
!RTS(3)=RES_FY(3)
!TEMP=CSZ(3)-CSZ(2)
!DTBM(2)=0.0-RES_FY(4)
!DTBM(1)=DTBM(2)-TEMP
!ENDIF
!ENDIF

!!方位约束
!IF(FLG_YS(6).EQ.1)THEN
!IF(GEO(2).LE.UP_YS(6))GEO(2)=UP_YS(6)
!IF(GEO(2).GE.DW_YU(6))GEO(2)=DW_YU(6)
!ENDIF

!!结果保存处理 2 层
!IF(GEO(2).GE.5.0.AND.GEO(2).LE.12.0)THEN  !下边界
!RTS(1)=RES_FY(2)
!RTS(2)=RES_FY(3)
!RTS(3)=RES_FY(2) !YS:RTS(3)=RES_FY(2)
!IF(ABS(RES_FY(4)).LE.1.0)THEN
!!DTBM(1)=-6.0
!DTBM(1)=0.0-MAX(ABS(THICK_LAYER)-ABS(RES_FY(4)),ABS(RES_FY(4)))
!DTBM(2)=RES_FY(4)
!RTS(1)=RES_FY(3)
!RTS(2)=RES_FY(3)
!RTS(3)=RES_FY(2) !YS:RTS(3)=RES_FY(2)
!ELSE
!!DTBM(1)=MAX(-6.0,RES_FY(4)-12.0)
!DTBM(1)=0.0-MAX(ABS(THICK_LAYER)-ABS(RES_FY(4)),ABS(RES_FY(4)))
!DTBM(2)=MIN(6.0,RES_FY(4))
!ENDIF
!ELSE
!RTS(1)=RES_FY(2)
!RTS(2)=RES_FY(3)
!RTS(3)=RES_FY(2) !YS:RTS(3)=RES_FY(3)
!IF(RES_FY(4).LE.1.0)THEN
!DTBM(1)=0.0-RES_FY(4)
!!DTBM(2)=6.0
!DTBM(2)=MAX(ABS(THICK_LAYER)-ABS(RES_FY(4)),ABS(RES_FY(4)))
!RTS(1)=RES_FY(2)
!RTS(2)=RES_FY(3)
!RTS(3)=RES_FY(3) !YS:RTS(3)=RES_FY(3)
!ELSE
!DTBM(1)=MAX(0.0-RES_FY(4),-6.0)
!!DTBM(2)=MIN(6.0,12.0-RES_FY(4))
!DTBM(2)=MAX(ABS(THICK_LAYER)-ABS(RES_FY(4)),ABS(RES_FY(4)))
!ENDIF
!ENDIF

!IF(ABS(DTBM(1)).GE.3.5)THEN
!DTBM(1)=-3.5+(3.5+DTBM(1))/(0.0-DTBM(1))
!ENDIF
!IF(ABS(DTBM(2)).GE.3.5)THEN
!DTBM(2)=3.5+(DTBM(2)-3.5)/(0.0+DTBM(1))
!ENDIF

!if(CSZ_TEMP(5).ge.CSZ_TEMP(4).and.CSZ_TEMP(5).gt.CSZ_TEMP(6))then
!if(RTS(2).le.RTS(1).or.RTS(2).le.RTS(3))then

!IF(GEO(2).GE.5.0.AND.GEO(2).LE.12.0)THEN  !下边界
!DTBM(1)=0.0-MAX(ABS(FY_RES(2)),ABS(FY_RES(3)))
!DTBM(2)=MIN(ABS(FY_RES(2)),ABS(FY_RES(3)))
!ELSE  !上边界
!DTBM(1)=0.0-MIN(ABS(FY_RES(2)),ABS(FY_RES(3)))
!DTBM(2)=MAX(ABS(FY_RES(2)),ABS(FY_RES(3)))
!ENDIF


TEMP=MAX(MIN((LOG(max(rb(3)**2.5*0.331,1.1))*0.51-0.0)*1.75,5.05),ABS(RES_RT(4))*1.0)+ABS(RES_RT(4))*0.1
IF(GEO(2).GE.5.0.AND.GEO(2).LE.12.0)THEN  !下边界
!DTBM(2)=MIN(ABS(FY_RES(2)),ABS(FY_RES(3)))
!DTBM(1)=MIN(-DTBM(2)-TEMP,-1.0*ABS(RES_RT(4)))
DTBM(2)=ABS(RES_RT(4))
DTBM(1)=(0.0-ABS(TEMP))*0.35+CSZ(2)*0.65 

ELSE  !上边界
!DTBM(1)=0.0-MIN(ABS(FY_RES(2)),ABS(FY_RES(3)))
!DTBM(2)=MAX(DTBM(1)+TEMP,1.0*ABS(RES_RT(4)))
DTBM(1)=0.0-ABS(RES_RT(4))
DTBM(2)=ABS(TEMP)*0.35+CSZ(3)*0.65 
ENDIF



!TEMP=0.0
!IF(MIN(RB(1),RB(2)).LT.10.0)THEN
!TEMP=(100.0-MIN(RB(1),RB(2))*MIN(RB(1),RB(2)))*0.005+0.3
!ELSE
!TEMP=0.3
!ENDIF
!
!IF(GEO(2).GE.5.0.AND.GEO(2).LE.12.0)THEN  !下边界
!DTBM(2)=ABS(RES_RT(4))-TEMP
!DTBM(1)=DTBM(1)-TEMP
!ELSE  !上边界
!DTBM(1)=0.0-ABS(RES_RT(4))+TEMP
!DTBM(2)=DTBM(2)+TEMP
!ENDIF


!DTBM(1)=0.0-ABS(RES_RT(4))
!DTBM(2)=ABS(RES_RT(4))


!!!!!初值约束
!IF(GEO(2).GE.5.0.AND.GEO(2).LE.12.0)THEN  !下边界
!IF(CSZ(2).GE.0.0)THEN !两个界面均在下方为
!DTBM(1)=MIN(ABS(FY_RES(2)),ABS(FY_RES(3)))
!DTBM(2)=MAX(ABS(FY_RES(2)),ABS(FY_RES(3)))
!ELSEIF(CSZ(3).LE.0.0-CSZ(2))THEN  !一上一下，离下边界近
!DTBM(1)=0.0-MAX(ABS(FY_RES(2)),ABS(FY_RES(3)))
!DTBM(2)=MIN(ABS(FY_RES(2)),ABS(FY_RES(3)))
!ELSE !一上一下，离上边界近
!DTBM(1)=0.0-MIN(ABS(FY_RES(2)),ABS(FY_RES(3)))
!DTBM(2)=MAX(ABS(FY_RES(2)),ABS(FY_RES(3)))
!ENDIF
!ELSE  !上边界
!IF(CSZ(3).LE.0.0)THEN !两个界面均在上方为
!DTBM(1)=0.0-MAX(ABS(FY_RES(2)),ABS(FY_RES(3)))
!DTBM(2)=0.0-MIN(ABS(FY_RES(2)),ABS(FY_RES(3)))
!ELSEIF(CSZ(3).GE.0.0-CSZ(2))THEN !一上一下，离上边界近
!DTBM(1)=0.0-MIN(ABS(FY_RES(2)),ABS(FY_RES(3)))
!DTBM(2)=MAX(ABS(FY_RES(2)),ABS(FY_RES(3)))
!ELSE
!DTBM(1)=0.0-MAX(ABS(FY_RES(2)),ABS(FY_RES(3)))
!DTBM(2)=MIN(ABS(FY_RES(2)),ABS(FY_RES(3)))
!ENDIF
!ENDIF
!IF(ABS(CSZ(2)).LE.ABS(CSZ(3)))THEN
!DTBM(1)=(DTBM(1)+2.0*CSZ(2))/3.0
!DTBM(2)=(DTBM(2)+1.0*CSZ(3))/2.0
!ELSE
!DTBM(2)=(DTBM(2)+2.0*CSZ(3))/3.0
!DTBM(1)=(DTBM(1)+1.0*CSZ(2))/2.0
!ENDIF
!!!!!初值约束结束





!!!!!电阻率约束
!RTS(1)=min(FY_RES(4)/3.0,RES_RT(3)/5.0)
!RTS(2)=RES_RT(3)
!RTS(3)=min(FY_RES(6)/3.0,RES_RT(3)/5.0)

IF(RES_RT(2).GE.RES_RT(3)*1.5+1.0)THEN
RTS(1)=MAX((RES_RT(2)+RES_RT(3)+0.0),1.5*RES_RT(3)+1.0)
RTS(2)=RES_RT(3)
RTS(3)=MAX((RES_RT(2)+RES_RT(3)+0.0),1.5*RES_RT(3)+1.0)
ELSE
RTS(1)=MIN((RES_RT(2)+RES_RT(3))/10.0+1.0,0.5*RES_RT(3))
RTS(2)=RES_RT(3)
RTS(3)=MIN((RES_RT(2)+RES_RT(3))/10.0+1.0,0.5*RES_RT(3))
ENDIF


!单边界显示//注释后多边界显示
IF(GEO(2).GE.5.0.AND.GEO(2).LE.12.0)THEN  !下边界
RTS(1)=(RTS(1)+RTS(2)*2)/3.0
RTS(3)=RES_RT(2)
ELSE
RTS(3)=(RTS(3)+RTS(2)*2.0)/3.0
RTS(1)=RES_RT(2)
ENDIF

!IF(CSZ(2).GE.0.0)THEN  !下边界
!DTBM(1)=ABS(DTBM(1)) !(ABS(DTBM(1))+CSZ(2))/2.0
!DTBM(2)=ABS(DTBM(2)) !(ABS(DTBM(2))+CSZ(3))/2.0
!ELSEIF(CSZ(3).LE.0.0)THEN !上边界
!DTBM(1)=0.0-ABS(DTBM(1)) !(0.0-ABS(DTBM(1))+CSZ(2))/2.0
!DTBM(2)=0.0-ABS(DTBM(2)) !(0.0-ABS(DTBM(2))+CSZ(3))/2.0
!ELSE !上下两个边界
!IF(ABS(CSZ(2)).LE.ABS(CSZ(3)))THEN !上边界
!DTBM(1)=0.0-MIN(ABS(DTBM(1)),ABS(DTBM(2)))
!DTBM(2)=0.0+MAX(ABS(DTBM(1)),ABS(DTBM(2)))
!ELSE
!DTBM(1)=0.0-MAX(ABS(DTBM(1)),ABS(DTBM(2)))
!DTBM(2)=0.0+MIN(ABS(DTBM(1)),ABS(DTBM(2)))
!ENDIF
!ENDIF


DO I=2,2
TEMP=I*1.75+3.55
IF(ABS(DTBM(1)).GE.TEMP)DTBM(1)=TEMP*DTBM(1)/ABS(DTBM(1))+(ABS(DTBM(1))-TEMP)*((DTBM(1))/TEMP)**3.0
IF(ABS(DTBM(2)).GE.TEMP)DTBM(2)=TEMP*DTBM(2)/ABS(DTBM(2))+(ABS(DTBM(2))-TEMP)*((DTBM(2))/TEMP)**3.0
ENDDO

END


SUBROUTINE Multi_Boundry_AziTrak_Invision(RA,GEO,CSZ,RES_RT,RTS,DTBM,FLG_YS,UP_YS,DW_YU,CSZ_TEMP)
!SUBROUTINE Multi_Boundry_Invision_AziTrak(RA,GEO,CSZ,RES_RT,RTS,DTBM,FLG_YS,UP_YS,DW_YU,FILENAME03,LEN2,EFF_CHECK)
!!DEC$ ATTRIBUTES DLLEXPORT :: Multi_Boundry_Invision_AziTrak
USE DB_DATA
IMPLICIT NONE
REAL*8,INTENT(INOUT)::RA(4),GEO(2),CSZ(6)
REAL*8,INTENT(OUT)::RES_RT(4)
REAL*8,INTENT(OUT)::RTS(3),DTBM(2)
INTEGER,INTENT(IN):: FLG_YS(6)
REAL*8,INTENT(IN):: UP_YS(6),DW_YU(6)
!!DEC$ ATTRIBUTES REFERENCE :: RA,GEO,CSZ
!!DEC$ ATTRIBUTES REFERENCE :: RES_RT,RTS,DTBM
!!DEC$ ATTRIBUTES REFERENCE :: FLG_YS,UP_YS,DW_YU

!INTEGER,INTENT(OUT)::EFF_CHECK
!INTEGER,INTENT(IN)::LEN2
!CHARACTER(LEN=LEN2),INTENT(IN) :: FILENAME03
!INTEGER STR_LEN
!!DEC$ ATTRIBUTES VALUE :: LEN2
!!DEC$ ATTRIBUTES REFERENCE :: FILENAME03
!!DEC$ ATTRIBUTES REFERENCE :: EFF_CHECK

!STR_LEN=LEN_TRIM(FILENAME03)
!CALL EFFCHECK(FILENAME03, STR_LEN, EFF_CHECK)
!IF(EFF_CHECK .NE. 0)THEN
!RETURN
!ENDIF

!声明临时变量
REAL*8 CZ(4),RB(5) !输入
REAL*8 RES_FY(4),ERR !输出
REAL*8 TEMP,THICK_LAYER
INTEGER I,J,K
REAL*8 CSZ_TEMP(6),THICK,FY_RES(6),AVER_RA,MIN_RAS,MAX_RAS

!!!!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!!!!正式版注释掉这一段代码 
!CHARACTER*10 DATE,TIME
!INTEGER IALLOC
!CALL DATE_AND_TIME(DATE,TIME)
!READ(DATE,"(I4)")IALLOC
!IF(IALLOC.GT.2025)THEN
!GEO=0.0
!RA=0.1*RA
!ENDIF
!!!!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
THICK_LAYER=CSZ(3)-CSZ(2)
THICK=THICK_LAYER
!print*,THICK

RTS(1:3)=CSZ(4:6)
DTBM(1:2)=CSZ(2:3)
!赋初值
CZ(1)=CSZ(1)  !倾角
IF(ABS(CSZ(2)).LE.ABS(CSZ(3)))THEN !离上边界近
CZ(4)=CSZ(2)  !上边界距离
ELSE
CZ(4)=CSZ(3)  !下边界距离
ENDIF
IF(ABS(CZ(4)-CSZ(2)).LE.1E-6)THEN !上边界
IF(CZ(4).GE.0.0)THEN
CZ(2)=CSZ(5) !RT
CZ(3)=CSZ(4) !RS
ELSE
CZ(2)=CSZ(4) !RT
CZ(3)=CSZ(5) !RS
ENDIF
ELSE  !下边界
IF(CZ(4).GE.0.0)THEN
CZ(2)=CSZ(6)
CZ(3)=CSZ(5)
ELSE
CZ(2)=CSZ(5)
CZ(3)=CSZ(6)
ENDIF
ENDIF

RB(1:4)=RA(1:4) 
RB(5)=GEO(1)

!IF(RB(1).GE.10.0.AND.RB(5).LE.100.0)RB(5)=100.0+(RB(5)-100.0)/(MAX(RB(1),2.0))
!反演计算 OK1
!IF(GEO(2).GE.5.0.AND.GEO(2).LE.12.0)THEN
CALL INV_AziTrack_LWD_CW(RB,CSZ,RES_RT,FY_RES,ERR,FLG_YS,UP_YS,DW_YU,CSZ_TEMP) !下边界反演
!ELSE
!CALL INV_AziTrack_LWD_CN(RB,CSZ,FY_RES,ERR,FLG_YS,UP_YS,DW_YU,CSZ_TEMP) !上边界反演
!ENDIF
!RES_FY(2)=(RES_FY(2)+CZ(2)*2.0)/3.0

!!反演计算 OK1 待优化
!CALL INV_AziTrack_LWD_CW(RB,CZ,RES_FY,ERR,FLG_YS,UP_YS,DW_YU,CSZ_TEMP) !下边界反演


!结果输出
!RES_RT(1:4)=RES_FY(1:4)
!if(cz(2).gt.cz(3))then
!RES_RT(2)=max(RES_FY(2),RES_FY(3))
!RES_RT(3)=min(RES_FY(2),RES_FY(3))
!else
!RES_RT(2)=min(RES_FY(2),RES_FY(3))
!RES_RT(3)=max(RES_FY(2),RES_FY(3))
!endif
!!结果保存处理 3层
!IF(GEO(2).GE.5.0.AND.GEO(2).LE.12.0)THEN  !下边界
!IF(CSZ(2).GE.0.0)THEN !第一个边界
!RTS(1)=RES_FY(3)
!RTS(2)=RES_FY(2)
!TEMP=CSZ(3)-CSZ(2)
!DTBM(1)=RES_FY(4)
!DTBM(2)=DTBM(1)+TEMP
!ELSEIF(CSZ(3).LT.0.0)THEN !第二个边界
!RTS(2)=RES_FY(3)
!RTS(3)=RES_FY(2)
!TEMP=CSZ(3)-CSZ(2)
!DTBM(2)=RES_FY(4)
!DTBM(1)=DTBM(2)-TEMP
!ENDIF
!ELSE  !上边界
!IF(CSZ(3).GT.0.0)THEN !第一个边界
!RTS(1)=RES_FY(2)
!RTS(2)=RES_FY(3)
!TEMP=CSZ(3)-CSZ(2)
!DTBM(1)=0.0-RES_FY(4)
!DTBM(2)=TEMP+DTBM(1)
!ELSEIF(CSZ(3).LE.0.0)THEN !第二个边界
!RTS(2)=RES_FY(2)
!RTS(3)=RES_FY(3)
!TEMP=CSZ(3)-CSZ(2)
!DTBM(2)=0.0-RES_FY(4)
!DTBM(1)=DTBM(2)-TEMP
!ENDIF
!ENDIF

!方位约束
IF(FLG_YS(6).EQ.1)THEN !方位约束
IF(GEO(2).LE.UP_YS(6))GEO(2)=UP_YS(6)
IF(GEO(2).GE.DW_YU(6))GEO(2)=DW_YU(6)
ENDIF


!!结果保存处理 2 层
!IF(GEO(2).GE.5.0.AND.GEO(2).LE.12.0)THEN  !下边界
!RTS(1)=RES_FY(2)
!RTS(2)=RES_FY(3)
!RTS(3)=RES_FY(2) !YS:RTS(3)=RES_FY(2)
!IF(ABS(RES_FY(4)).LE.1.0)THEN
!!DTBM(1)=-6.0
!DTBM(1)=0.0-MAX(ABS(THICK_LAYER)-ABS(RES_FY(4)),ABS(RES_FY(4)))
!DTBM(2)=RES_FY(4)
!RTS(1)=RES_FY(3)
!RTS(2)=RES_FY(3)
!RTS(3)=RES_FY(2) !YS:RTS(3)=RES_FY(2)
!ELSE
!!DTBM(1)=MAX(-6.0,RES_FY(4)-12.0)
!DTBM(1)=0.0-MAX(ABS(THICK_LAYER)-ABS(RES_FY(4)),ABS(RES_FY(4)))
!DTBM(2)=MIN(6.0,RES_FY(4))
!ENDIF
!ELSE
!RTS(1)=RES_FY(2)
!RTS(2)=RES_FY(3)
!RTS(3)=RES_FY(2) !YS:RTS(3)=RES_FY(3)
!IF(RES_FY(4).LE.1.0)THEN
!DTBM(1)=0.0-RES_FY(4)
!!DTBM(2)=6.0
!DTBM(2)=MAX(ABS(THICK_LAYER)-ABS(RES_FY(4)),ABS(RES_FY(4)))
!RTS(1)=RES_FY(2)
!RTS(2)=RES_FY(3)
!RTS(3)=RES_FY(3) !YS:RTS(3)=RES_FY(3)
!ELSE
!DTBM(1)=MAX(0.0-RES_FY(4),-6.0)
!!DTBM(2)=MIN(6.0,12.0-RES_FY(4))
!DTBM(2)=MAX(ABS(THICK_LAYER)-ABS(RES_FY(4)),ABS(RES_FY(4)))
!ENDIF
!ENDIF

!IF(ABS(DTBM(1)).GE.3.5)THEN
!DTBM(1)=-3.5+(3.5+DTBM(1))/(0.0-DTBM(1))
!ENDIF
!IF(ABS(DTBM(2)).GE.3.5)THEN
!DTBM(2)=3.5+(DTBM(2)-3.5)/(0.0+DTBM(1))
!ENDIF

!if(CSZ_TEMP(5).ge.CSZ_TEMP(4).and.CSZ_TEMP(5).gt.CSZ_TEMP(6))then
!if(RTS(2).le.RTS(1).or.RTS(2).le.RTS(3))then

!IF(GEO(2).GE.5.0.AND.GEO(2).LE.12.0)THEN  !下边界
!DTBM(1)=0.0-MAX(ABS(FY_RES(2)),ABS(FY_RES(3)))
!DTBM(2)=MIN(ABS(FY_RES(2)),ABS(FY_RES(3)))
!ELSE  !上边界
!DTBM(1)=0.0-MIN(ABS(FY_RES(2)),ABS(FY_RES(3)))
!DTBM(2)=MAX(ABS(FY_RES(2)),ABS(FY_RES(3)))
!ENDIF


!TEMP=MAX(MIN((LOG(max(rb(3)**2.5*0.331,1.1))*0.51-0.0)*1.75,5.05),ABS(RES_RT(4))*1.0)+ABS(RES_RT(4))*0.1
TEMP=THICK-ABS(RES_RT(4))

IF(GEO(2).GE.5.0.AND.GEO(2).LE.12.0)THEN  !下边界
!DTBM(2)=MIN(ABS(FY_RES(2)),ABS(FY_RES(3)))
!DTBM(1)=MIN(-DTBM(2)-TEMP,-1.0*ABS(RES_RT(4)))
DTBM(2)=ABS(RES_RT(4))
DTBM(1)=(0.0-ABS(TEMP)) 
ELSE  !上边界
!DTBM(1)=0.0-MIN(ABS(FY_RES(2)),ABS(FY_RES(3)))
!DTBM(2)=MAX(DTBM(1)+TEMP,1.0*ABS(RES_RT(4)))
DTBM(1)=0.0-ABS(RES_RT(4))
DTBM(2)=ABS(TEMP) 
ENDIF



!TEMP=0.0
!IF(MIN(RB(1),RB(2)).LT.10.0)THEN
!TEMP=(100.0-MIN(RB(1),RB(2))*MIN(RB(1),RB(2)))*0.005+0.3
!ELSE
!TEMP=0.3
!ENDIF
!
!IF(GEO(2).GE.5.0.AND.GEO(2).LE.12.0)THEN  !下边界
!DTBM(2)=ABS(RES_RT(4))-TEMP
!DTBM(1)=DTBM(1)-TEMP
!ELSE  !上边界
!DTBM(1)=0.0-ABS(RES_RT(4))+TEMP
!DTBM(2)=DTBM(2)+TEMP
!ENDIF


!DTBM(1)=0.0-ABS(RES_RT(4))
!DTBM(2)=ABS(RES_RT(4))


!!!!!初值约束
!IF(GEO(2).GE.5.0.AND.GEO(2).LE.12.0)THEN  !下边界
!IF(CSZ(2).GE.0.0)THEN !两个界面均在下方为
!DTBM(1)=MIN(ABS(FY_RES(2)),ABS(FY_RES(3)))
!DTBM(2)=MAX(ABS(FY_RES(2)),ABS(FY_RES(3)))
!ELSEIF(CSZ(3).LE.0.0-CSZ(2))THEN  !一上一下，离下边界近
!DTBM(1)=0.0-MAX(ABS(FY_RES(2)),ABS(FY_RES(3)))
!DTBM(2)=MIN(ABS(FY_RES(2)),ABS(FY_RES(3)))
!ELSE !一上一下，离上边界近
!DTBM(1)=0.0-MIN(ABS(FY_RES(2)),ABS(FY_RES(3)))
!DTBM(2)=MAX(ABS(FY_RES(2)),ABS(FY_RES(3)))
!ENDIF
!ELSE  !上边界
!IF(CSZ(3).LE.0.0)THEN !两个界面均在上方为
!DTBM(1)=0.0-MAX(ABS(FY_RES(2)),ABS(FY_RES(3)))
!DTBM(2)=0.0-MIN(ABS(FY_RES(2)),ABS(FY_RES(3)))
!ELSEIF(CSZ(3).GE.0.0-CSZ(2))THEN !一上一下，离上边界近
!DTBM(1)=0.0-MIN(ABS(FY_RES(2)),ABS(FY_RES(3)))
!DTBM(2)=MAX(ABS(FY_RES(2)),ABS(FY_RES(3)))
!ELSE
!DTBM(1)=0.0-MAX(ABS(FY_RES(2)),ABS(FY_RES(3)))
!DTBM(2)=MIN(ABS(FY_RES(2)),ABS(FY_RES(3)))
!ENDIF
!ENDIF
!IF(ABS(CSZ(2)).LE.ABS(CSZ(3)))THEN
!DTBM(1)=(DTBM(1)+2.0*CSZ(2))/3.0
!DTBM(2)=(DTBM(2)+1.0*CSZ(3))/2.0
!ELSE
!DTBM(2)=(DTBM(2)+2.0*CSZ(3))/3.0
!DTBM(1)=(DTBM(1)+1.0*CSZ(2))/2.0
!ENDIF
!!!!!初值约束结束





!!!!!电阻率约束
!RTS(1)=min(FY_RES(4)/3.0,RES_RT(3)/5.0)
!RTS(2)=RES_RT(3)
!RTS(3)=min(FY_RES(6)/3.0,RES_RT(3)/5.0)

IF(RES_RT(2).GE.RES_RT(3)*1.5+1.0)THEN
RTS(1)=MAX((RES_RT(2)+RES_RT(3)+0.0),1.5*RES_RT(3)+1.0)
RTS(2)=RES_RT(3)
RTS(3)=MAX((RES_RT(2)+RES_RT(3)+0.0),1.5*RES_RT(3)+1.0)
ELSE
RTS(1)=MIN((RES_RT(2)+RES_RT(3))/10.0+1.0,0.5*RES_RT(3))
RTS(2)=RES_RT(3)
RTS(3)=MIN((RES_RT(2)+RES_RT(3))/10.0+1.0,0.5*RES_RT(3))
ENDIF


!!单边界显示//注释后多边界显示
!IF(GEO(2).GE.5.0.AND.GEO(2).LE.12.0)THEN  !下边界
!RTS(1)=(RTS(1)+RTS(2)*2)/3.0
!RTS(3)=RES_RT(2)
!ELSE
!RTS(3)=(RTS(3)+RTS(2)*2.0)/3.0
!RTS(1)=RES_RT(2)
!ENDIF

!IF(CSZ(2).GE.0.0)THEN  !下边界
!DTBM(1)=ABS(DTBM(1)) !(ABS(DTBM(1))+CSZ(2))/2.0
!DTBM(2)=ABS(DTBM(2)) !(ABS(DTBM(2))+CSZ(3))/2.0
!ELSEIF(CSZ(3).LE.0.0)THEN !上边界
!DTBM(1)=0.0-ABS(DTBM(1)) !(0.0-ABS(DTBM(1))+CSZ(2))/2.0
!DTBM(2)=0.0-ABS(DTBM(2)) !(0.0-ABS(DTBM(2))+CSZ(3))/2.0
!ELSE !上下两个边界
!IF(ABS(CSZ(2)).LE.ABS(CSZ(3)))THEN !上边界
!DTBM(1)=0.0-MIN(ABS(DTBM(1)),ABS(DTBM(2)))
!DTBM(2)=0.0+MAX(ABS(DTBM(1)),ABS(DTBM(2)))
!ELSE
!DTBM(1)=0.0-MAX(ABS(DTBM(1)),ABS(DTBM(2)))
!DTBM(2)=0.0+MIN(ABS(DTBM(1)),ABS(DTBM(2)))
!ENDIF
!ENDIF


DO I=2,2
TEMP=I*1.75+3.55
IF(ABS(DTBM(1)).GE.TEMP)DTBM(1)=TEMP*DTBM(1)/ABS(DTBM(1))+(ABS(DTBM(1))-TEMP)*((DTBM(1))/TEMP)**3.0
IF(ABS(DTBM(2)).GE.TEMP)DTBM(2)=TEMP*DTBM(2)/ABS(DTBM(2))+(ABS(DTBM(2))-TEMP)*((DTBM(2))/TEMP)**3.0
ENDDO

END



SUBROUTINE AziTrakFM(DIPI,RSI,RTI,DTBI,RAD)
USE DB_DATA
IMPLICIT NONE
REAL*8 DIPI,RSI,RTI,DTBI
REAL*8 RA(5)
REAL*8 RAS(16,5),RAD(5)
INTEGER IU,ID,JU,JD,KU,KD,MU,MD,NU,ND
REAL*8 TEMP1,TEMP2,TEMP3,TEMP4,TEMP5
INTEGER II,JJ,KK,MM,NN
INTEGER I,J
!DIPI=85.0
DTBI=ABS(DTBI)
DIPI=ABS(DIPI)
IF(DIPI.GT.90.0)DIPI=180.0-DIPI
RSI=MAX(INT(RSI)*1.0,1.0)
RTI=MAX(INT(RTI)*1.0,1.0)
DTBI=INT(DTBI*100)/100.0
!PRINT*,DTBI
!倾角数据库定位
IF(ABS(DIPI).LE.0.0)THEN
IU=1
ID=2
TEMP1=(DIPI-DIP(1))/(DIP(2)-DIP(1))
ELSEIF(ABS(DIPI).GE.89.99)THEN
IU=19
ID=20
TEMP1=(DIPI-DIP(19))/(DIP(20)-DIP(19))
ELSE
DO I=1,19
IF(DIPI.GE.DIP(I).AND.DIPI.LT.DIP(I+1))THEN
IU=I
ID=I+1
TEMP1=(DIPI-DIP(I))/(DIP(I+1)-DIP(I))
EXIT
ENDIF
ENDDO
ENDIF
!围岩数据库定位
IF(RSI.LE.RS(1))THEN
JU=1
JD=2
TEMP2=(RSI-RS(1))/(RS(2)-RS(1))
ELSEIF(RSI.GE.RS(45))THEN
JU=44
JD=45
TEMP2=(RSI-RS(44))/(RS(45)-RS(44))
ELSE
DO I=1,44
IF(RSI.GE.RS(I).AND.RSI.LT.RS(I+1))THEN
JU=I
JD=I+1
TEMP2=(RSI-RS(I))/(RS(I+1)-RS(I))
EXIT
ENDIF
ENDDO
ENDIF
!目的层电阻率数据库定位
IF(RTI.LE.RT(1))THEN
KU=1
KD=2
TEMP3=(RTI-RT(1))/(RT(2)-RT(1))
ELSEIF(RTI.GE.RT(50))THEN
KU=49
KD=50
TEMP3=(RTI-RT(49))/(RT(50)-RT(49))
ELSE
DO I=1,49
IF(RTI.GE.RT(I).AND.RTI.LT.RT(I+1))THEN
KU=I
KD=I+1
TEMP3=(RTI-RT(I))/(RT(I+1)-RT(I))
EXIT
ENDIF
ENDDO
ENDIF
!边界距离数据库定位
IF(DTBI.LE.DTB(1))THEN
MU=1
MD=2
TEMP4=(DTBI-DTB(1))/(DTB(2)-DTB(1))
ELSEIF(DTBI.GE.DTB(61))THEN
MU=60
MD=61
TEMP4=(DTBI-DTB(60))/(DTB(61)-DTB(60))
ELSE
DO I=1,60
IF(DTBI.GE.DTB(I).AND.DTBI.LT.DTB(I+1))THEN
MU=I
MD=I+1
TEMP4=(DTBI-DTB(I))/(DTB(I+1)-DTB(I))
EXIT
ENDIF
ENDDO
ENDIF
NN=0
DO II=IU,ID
DO JJ=JU,JD
DO KK=KU,KD
DO MM=MU,MD
NN=NN+1
RAS(NN,1:5)=DATABASE(II,JJ,KK,MM,1:5)
ENDDO
ENDDO
ENDDO
ENDDO
!线性差值
DO J=1,5
DO I=1,8
RAS(I,J)=(1.0-TEMP1)*RAS(I,J)+TEMP1*RAS(I+8,J)
ENDDO
ENDDO
DO J=1,5
DO I=1,4
RAS(I,J)=(1.0-TEMP2)*RAS(I,J)+TEMP2*RAS(I+4,J)
ENDDO
ENDDO
DO J=1,5
DO I=1,2
RAS(I,J)=(1.0-TEMP3)*RAS(I,J)+TEMP3*RAS(I+2,J)
ENDDO
ENDDO
DO J=1,5
DO I=1,1
RAS(I,J)=(1.0-TEMP4)*RAS(I,J)+TEMP4*RAS(I+1,J)
ENDDO
ENDDO
RA(1:5)=RAS(1,1:5)
RA(5)=ABS(RA(5)*235.0)*log10(max((RSI+RTI)/5.0,1.5)) !*MAX(RA(3)/2.0,1.0) !刻度系数
RAD=RA

DO I=1,5
!RAD(I)=RAD(I)-MOD(RAD(I),0.001) !保留3位有效数字
RAD(I)=INT(RAD(I)*1000)/1000.0 !保留3位有效数字
ENDDO
END



SUBROUTINE INV_AziTrack(RB,CSZ,RES_FY,ERR0,YS_FLAG,UP_YS,DW_YU,CSZ_TEMP)
IMPLICIT NONE
REAL*8 RB(5)
REAL*8 CSZ(4),RES_FY(4)
REAL*8 RA(5)
REAL*8 DIP0,RS0,RT0,DTB0
REAL*8 DIPU,DIPD
REAL*8 RSU,RSD
REAL*8 RTU,RTD
REAL*8 DTBU,DTBD
INTEGER MDIP,MRS,MRT,MDB
INTEGER I,J,K,M,N
REAL*8 ERR0,ERR1
INTEGER YS_FLAG(6),YSs_FLAG(6),YSe_FLAG(6)
REAL*8 UP_YS(6),DW_YU(6)
REAL*8 YSZ(6),CSZ_TEMP(6)
REAL*8 TIM1,TIM2
REAL*8 RA2RT
REAL*8 GEO(2)
REAL*8 MAX_CZ,MIN_CZ,RAD(4)

RAD(1:4)=RB(1:4)
DIPU=CSZ(1)
DIPD=CSZ(1)
!DIPU=85.0

RSU=MAX(CSZ(2)-5.0,1.0)
RSD=CSZ(2)+5.0
RTU=MAX(CSZ(3)-20.0,1.0)
RTD=CSZ(3)+20.0
DTBU=0.0
DTBD=6.0


IF(YS_FLAG(1).EQ.1)THEN !倾角约束
DIPU=UP_YS(1)
DIPD=DW_YU(1)
ENDIF
IF(YS_FLAG(2).EQ.1)THEN !围岩约束
RSU=UP_YS(2)
RSD=DW_YU(2)
ENDIF
IF(YS_FLAG(3).EQ.1)THEN !目的层电阻率
RTU=UP_YS(3)
RTD=DW_YU(3)
ENDIF
IF(YS_FLAG(4).EQ.1)THEN !边界距离
DTBU=UP_YS(4)
DTBD=DW_YU(4)
ENDIF
IF(YS_FLAG(5).EQ.1)THEN !方位约束
DTBU=UP_YS(5)
DTBD=DW_YU(5)
ENDIF
IF(YS_FLAG(6).EQ.1)THEN !各项异性约束
ENDIF


MDIP=1
MRS=MAX(MIN(100,INT(RSD-RSU)),1)
MRT=MAX(MIN(100,INT(RTD-RTU)),1)
MDB=601


ERR0=1.0e+12
RB=INT(RB*1000)/1000.0
!边界距离反演
!DIP0=85.0
DIP0=CSZ(1)

DO K=1,20
RS0=(K)*1.0
DO J=1,20
RT0=J*1.0
DO I=1,MDB
DTB0=(I-1)*0.01
CALL AziTrakFM(DIP0,RS0,RT0,DTB0,RA)
RA=INT(RA*1000)/1000.0
ERR1=ABS(ABS(RB(5))-ABS(RA(5)))+ABS(ABS(RB(4))-ABS(RA(4)))+ABS(ABS(RB(3))-ABS(RA(3)))+ABS(ABS(RB(2))-ABS(RA(2)))+ABS(ABS(RB(1))-ABS(RA(1)))
IF(ERR1.LT.ERR0)THEN
ERR0=ERR1
RES_FY(1)=DIP0
RES_FY(2)=RS0
RES_FY(3)=RT0
RES_FY(4)=DTB0
IF(ERR0.LE.1.0E-6)THEN
EXIT
ENDIF
ENDIF
ENDDO
ENDDO
ENDDO

!!边界距离反演
!!DIP0=85.0
!DIP0=CSZ(1)
!
!RS0=1.0
!RT0=12.0
!DO I=1,MDB
!DTB0=(I-1)*0.01
!CALL AziTrakFM(DIP0,RS0,RT0,DTB0,RA)
!RA=INT(RA*1000)/1000.0
!ERR1=ABS(ABS(RB(5))-ABS(RA(5)))+ABS(ABS(RB(4))-ABS(RA(4)))+ABS(ABS(RB(3))-ABS(RA(3)))+ABS(ABS(RB(2))-ABS(RA(2)))+ABS(ABS(RB(1))-ABS(RA(1)))
!IF(ERR1.LT.ERR0)THEN
!ERR0=ERR1
!RES_FY(1)=DIP0
!RES_FY(2)=RS0
!RES_FY(3)=RT0
!RES_FY(4)=DTB0
!IF(ERR0.LE.1.0E-6)THEN
!EXIT
!ENDIF
!ENDIF
!ENDDO
!RS0=12.0
!RT0=1.0
!DO I=1,MDB
!DTB0=(I-1)*0.01
!CALL AziTrakFM(DIP0,RS0,RT0,DTB0,RA)
!RA=INT(RA*1000)/1000.0
!ERR1=ABS(ABS(RB(5))-ABS(RA(5)))+ABS(ABS(RB(4))-ABS(RA(4)))+ABS(ABS(RB(3))-ABS(RA(3)))+ABS(ABS(RB(2))-ABS(RA(2)))+ABS(ABS(RB(1))-ABS(RA(1)))
!IF(ERR1.LT.ERR0)THEN
!ERR0=ERR1
!RES_FY(1)=DIP0
!RES_FY(2)=RS0
!RES_FY(3)=RT0
!RES_FY(4)=DTB0
!IF(ERR0.LE.1.0E-6)THEN
!EXIT
!ENDIF
!ENDIF
!ENDDO





110 RETURN
END




SUBROUTINE INV_AziTrack_LWD_CN(RB,CSZ,RES_FY,ERR0,YS_FLAG,UP_YS,DW_YU,CSZ_TEMP)  !CSZ_TEMP：dip,dtbu,dtbd,rsu,rt,rsd
IMPLICIT NONE
REAL*8 RB(5)
REAL*8 CSZ(4),RES_FY(4)
REAL*8 RA(5)
REAL*8 DIP0,RS0,RT0,DTB0
REAL*8 DIPU,DIPD
REAL*8 RSU,RSD
REAL*8 RTU,RTD
REAL*8 DTBU,DTBD
INTEGER MDIP,MRS,MRT,MDB
INTEGER I,J,K,M,N
REAL*8 ERR0,ERR1
INTEGER YS_FLAG(6),YSs_FLAG(6),YSe_FLAG(6)
REAL*8 UP_YS(6),DW_YU(6)
REAL*8 YSZ(6),CSZ_TEMP(6)
REAL*8 TIM1,TIM2
REAL*8 RA2RT
REAL*8 GEO(2)
REAL*8 MAX_CZ,MIN_CZ,RAD(4)
REAL*8 RA0(4),SIGNAL0(2),LAMT0

RAD(1:4)=RB(1:4)
DIPU=CSZ(1)
DIPD=CSZ(1)
!DIPU=85.0
RSU=MAX(CSZ(2)-5.0,1.0)
RSD=CSZ(2)+5.0
RTU=MAX(CSZ(3)-20.0,1.0)
RTD=CSZ(3)+20.0
DTBU=0.0
DTBD=6.0


IF(YS_FLAG(1).EQ.1)THEN !倾角约束
DIPU=UP_YS(1)
DIPD=DW_YU(1)
ENDIF
IF(YS_FLAG(2).EQ.1)THEN !围岩约束
RSU=UP_YS(2)
RSD=DW_YU(2)
ENDIF
IF(YS_FLAG(3).EQ.1)THEN !目的层电阻率
RTU=UP_YS(3)
RTD=DW_YU(3)
ENDIF
IF(YS_FLAG(4).EQ.1)THEN !边界距离
DTBU=UP_YS(4)
DTBD=DW_YU(4)
ENDIF
IF(YS_FLAG(5).EQ.1)THEN !方位约束
DTBU=UP_YS(5)
DTBD=DW_YU(5)
ENDIF
IF(YS_FLAG(6).EQ.1)THEN !各项异性约束
ENDIF


MDIP=1
MRS=MAX(MIN(100,INT(RSD-RSU)),1)
MRT=MAX(MIN(100,INT(RTD-RTU)),1)
MDB=601




!!!!!!!****************************!!!!!!!!!!
     YSS_FLAG=YS_FLAG
     YSe_FLAG=YS_FLAG
     IF(YS_FLAG(3).EQ.0)THEN !目的层无约束情况
     YSS_FLAG(3)=1
     UP_YS(3)=RA2RT(RAD,GEO)*0.95
     DW_YU(3)=RA2RT(RAD,GEO)*1.25
     ELSE
     ENDIF
     MIN_CZ=MIN(MIN(CSZ_TEMP(4),CSZ_TEMP(5)),CSZ_TEMP(6))
     MAX_CZ=MAX(MAX(CSZ_TEMP(4),CSZ_TEMP(5)),CSZ_TEMP(6))
     MIN_CZ=MIN(MIN_CZ,0.2*RA2RT(RAD,GEO))
     MAX_CZ=MAX(MAX_CZ,5.0*RA2RT(RAD,GEO))
     IF(YSS_FLAG(2).EQ.0)THEN !围岩无约束情况
     YS_FLAG(2)=1
     IF(RA2RT(RAD,GEO).LE.MIN_CZ)THEN
     UP_YS(2)=MAX_CZ*1.05
     DW_YU(2)=MAX_CZ*1.25
     ELSE
     UP_YS(2)=MIN_CZ*1.05
     DW_YU(2)=MIN_CZ*1.25
     ENDIF
     ENDIF

     DO I=1,4
     IF(RAD(I).LE.0.2.OR.RAD(I).GE.300.0)THEN
     RAD(I)=RA2RT(RAD,GEO)
     ENDIF
     ENDDO
     !GR泥岩约束
     IF(RA2RT(RAD,GEO).LE.2.0)THEN  !泥岩
     UP_YS(2)=RA2RT(RAD,GEO)*5.0
     DW_YU(2)=RA2RT(RAD,GEO)*10.0
     ENDIF

IF(YS_FLAG(1).EQ.1)THEN !倾角约束
DIPU=UP_YS(1)
DIPD=DW_YU(1)
ENDIF
IF(YSS_FLAG(2).EQ.1)THEN !围岩约束
RSU=UP_YS(2)
RSD=DW_YU(2)
ENDIF
IF(YSS_FLAG(3).EQ.1)THEN !目的层电阻率
RTU=UP_YS(3)
RTD=DW_YU(3)
ENDIF
IF(YS_FLAG(4).EQ.1)THEN !边界距离
DTBU=UP_YS(4)
DTBD=DW_YU(4)
ENDIF
IF(YS_FLAG(5).EQ.1)THEN !方位约束
DTBU=UP_YS(5)
DTBD=DW_YU(5)
ENDIF
IF(YS_FLAG(6).EQ.1)THEN !各项异性约束
ENDIF

MDIP=1
MRS=MAX(MIN(100,INT(RSD-RSU)),1)
MRT=MAX(MIN(100,INT(RTD-RTU)),1)
MDB=601
!!!!!!************************************!!!!!!!


!CALL CPU_TIME(TIM1) !记录反演开始时间
!全参数反演，获取初值
ERR0=1E+12
DO M=1,MDIP
DIP0=DIPU+(M-1)*(DIPD-DIPU)/(MDIP)
DO K=1,MRS
RS0=RSU+(K-1) !*(INT(RSD-RSU))/(MRS)
!RS0=K
DO J=1,MRT+1
RT0=RTU+(J-1) !*(INT(RTD-RTU))/(MRT)
!RT0=J
DO I=1,MDB
DTB0=(I-1)*0.01

!围岩-目的层
!CALL AziTrakFM(DIP0,RS0,RT0,DTB0,RA)
CALL BD_BHCS(DIP0,RS0,RT0,DTB0,RA,CSZ_TEMP)
!!层厚不变，靠近上边界
!IF(DTB0.LE.(CSZ_TEMP(3)-CSZ_TEMP(2))/2.0)THEN
!CALL DOUBLE_BD_AziTrakFM(RS0,RT0,CSZ_TEMP(6),DTB0,CSZ_TEMP(3),DIP0,LAMT0,RA0,SIGNAL0)
!ELSE
!!层厚不变，靠近下边界
!CALL DOUBLE_BD_AziTrakFM(CSZ_TEMP(4),RT0,RS0,CSZ_TEMP(2),DTB0,DIP0,LAMT0,RA0,SIGNAL0)
!ENDIF
!RA(1:4)=RA0(1:4)
!RA(5)=SIGNAL0(1)


ERR1=0.0
DO N=1,4
IF(RB(N).LE.5000.0.AND.RB(N).GE.0.5)THEN
ERR1=ERR1+ABS(RB(N)-RA(N))
ENDIF
ENDDO
ERR1=ERR1+ABS(ABS(RB(5))-ABS(RA(5)))
IF(ERR1.le.ERR0-1.0E-5)THEN
ERR0=ERR1
RES_FY(1)=DIP0
RES_FY(2)=RS0
RES_FY(3)=RT0
RES_FY(4)=DTB0
IF(ERR0.LE.1.0E-6)EXIT
ENDIF

ENDDO
ENDDO
ENDDO
ENDDO


!边界距离反演
!ERR0=1E+12
!DIP0=85.0
DIP0=CSZ(1)

RS0=RES_FY(2)
RT0=RES_FY(3)
DO I=1,MDB
DTB0=(I-1)*0.01
!CALL AziTrakFM(DIP0,RS0,RT0,DTB0,RA)
CALL BD_BHCS(DIP0,RS0,RT0,DTB0,RA,CSZ_TEMP)
!层厚不变，靠近上边界
!IF(DTB0.LE.(CSZ_TEMP(3)-CSZ_TEMP(2))/2.0)THEN
!CALL DOUBLE_BD_AziTrakFM(RS0,RT0,CSZ_TEMP(6),DTB0,CSZ_TEMP(3),DIP0,LAMT0,RA0,SIGNAL0)
!ELSE
!!层厚不变，靠近下边界
!CALL DOUBLE_BD_AziTrakFM(CSZ_TEMP(4),RT0,RS0,CSZ_TEMP(2),DTB0,DIP0,LAMT0,RA0,SIGNAL0)
!ENDIF
!RA(1:4)=RA0(1:4)
!RA(5)=SIGNAL0(1)


ERR1=ABS(ABS(RB(5))-ABS(RA(5)))
IF(ERR1.le.ERR0-1.0E-5)THEN
ERR0=ERR1
RES_FY(4)=DTB0
IF(ERR0.LE.1.0E-6)EXIT
ENDIF
ENDDO





!!RS反演电阻率
!!ERR0=1E+12
!DIP0=85.0
DIP0=CSZ(1)

DTB0=RES_FY(4)
DO K=1,MRS
RS0=RSU+(K-1) !*(INT(RSD-RSU))/(MRS)
!RS0=K
!DO J=1,MRT+1
!RT0=RTU+(J-1) !*(INT(RTD-RTU))/(MRT)
!围岩-目的层
!CALL AziTrakFM(DIP0,RS0,RT0,DTB0,RA)
CALL BD_BHCS(DIP0,RS0,RT0,DTB0,RA,CSZ_TEMP)
!!层厚不变，靠近上边界
!IF(DTB0.LE.(CSZ_TEMP(3)-CSZ_TEMP(2))/2.0)THEN
!CALL DOUBLE_BD_AziTrakFM(RS0,RT0,CSZ_TEMP(6),DTB0,CSZ_TEMP(3),DIP0,LAMT0,RA0,SIGNAL0)
!ELSE
!!层厚不变，靠近下边界
!CALL DOUBLE_BD_AziTrakFM(CSZ_TEMP(4),RT0,RS0,CSZ_TEMP(2),DTB0,DIP0,LAMT0,RA0,SIGNAL0)
!ENDIF
!RA(1:4)=RA0(1:4)
!RA(5)=SIGNAL0(1)


ERR1=0.0
DO N=1,4
IF(RB(N).LE.5000.0.AND.RB(N).GE.0.5)THEN
ERR1=ERR1+ABS(RB(N)-RA(N))
ENDIF
ENDDO
ERR1=ERR1+ABS(ABS(RB(5))-ABS(RA(5)))
IF(ERR1.le.ERR0-1.0E-5)THEN
ERR0=ERR1
RES_FY(2)=RS0
RES_FY(3)=RT0
IF(ERR0.LE.1.0E-6)EXIT
ENDIF
ENDDO
!ENDDO

!!RT反演电阻率
!!ERR0=1E+12
!DIP0=85.0
DIP0=CSZ(1)

DTB0=RES_FY(4)
!DO K=1,MRS
!RS0=RSU+(K-1) !*(INT(RSD-RSU))/(MRS)
!RS0=K
DO J=1,MRT+1
RT0=RTU+(J-1) !*(INT(RTD-RTU))/(MRT)
!围岩-目的层
!CALL AziTrakFM(DIP0,RS0,RT0,DTB0,RA)
CALL BD_BHCS(DIP0,RS0,RT0,DTB0,RA,CSZ_TEMP)
!!层厚不变，靠近上边界
!IF(DTB0.LE.(CSZ_TEMP(3)-CSZ_TEMP(2))/2.0)THEN
!CALL DOUBLE_BD_AziTrakFM(RS0,RT0,CSZ_TEMP(6),DTB0,CSZ_TEMP(3),DIP0,LAMT0,RA0,SIGNAL0)
!ELSE
!!层厚不变，靠近下边界
!CALL DOUBLE_BD_AziTrakFM(CSZ_TEMP(4),RT0,RS0,CSZ_TEMP(2),DTB0,DIP0,LAMT0,RA0,SIGNAL0)
!ENDIF
!RA(1:4)=RA0(1:4)
!RA(5)=SIGNAL0(1)


ERR1=0.0
DO N=1,4
IF(RB(N).LE.5000.0.AND.RB(N).GE.0.5)THEN
ERR1=ERR1+ABS(RB(N)-RA(N))
ENDIF
ENDDO
ERR1=ERR1+ABS(ABS(RB(5))-ABS(RA(5)))
IF(ERR1.le.ERR0-1.0E-5)THEN
ERR0=ERR1
RES_FY(2)=RS0
RES_FY(3)=RT0
IF(ERR0.LE.1.0E-6)EXIT
ENDIF
ENDDO
!ENDDO



!DIP0=85.0
!DTB0=RES_FY(4)
!DO K=1,MRS
!RS0=RSU+(K-1) !*(INT(RSD-RSU))/(MRS)
!!RS0=K
!DO J=1,MRT+1
!RT0=RTU+(J-1) !*(INT(RTD-RTU))/(MRT)
!!围岩-目的层
!CALL AziTrakFM(DIP0,RS0,RT0,DTB0,RA)
!ERR1=0.0
!DO N=1,4
!IF(RB(N).LE.5000.0.AND.RB(N).GE.0.5)THEN
!ERR1=ERR1+ABS(RB(N)-RA(N))
!ENDIF
!ENDDO
!ERR1=ERR1+ABS(ABS(RB(5))-ABS(RA(5)))
!IF(ERR1.le.ERR0-1.0E-5)THEN
!ERR0=ERR1
!RES_FY(2)=RS0
!RES_FY(3)=RT0
!IF(ERR0.LE.1.0E-6)EXIT
!ENDIF
!ENDDO
!ENDDO


!边界距离反演
!DIP0=85.0
DIP0=CSZ(1)

YS_FLAG=YSe_FLAG
!CALL AziTrakFM(DIP0,RES_FY(2),RES_FY(3),RES_FY(4),RA)
CALL BD_BHCS(DIP0,RES_FY(2),RES_FY(3),RES_FY(4),RA,CSZ_TEMP)
!!层厚不变，靠近上边界
!IF(DTB0.LE.(CSZ_TEMP(3)-CSZ_TEMP(2))/2.0)THEN
!CALL DOUBLE_BD_AziTrakFM(RS0,RT0,CSZ_TEMP(6),DTB0,CSZ_TEMP(3),DIP0,LAMT0,RA0,SIGNAL0)
!ELSE
!!层厚不变，靠近下边界
!CALL DOUBLE_BD_AziTrakFM(CSZ_TEMP(4),RT0,RS0,CSZ_TEMP(2),DTB0,DIP0,LAMT0,RA0,SIGNAL0)
!ENDIF
!RA(1:4)=RA0(1:4)
!RA(5)=SIGNAL0(1)




ERR0=ABS(ABS(RB(5))-ABS(RA(5)))+ABS(ABS(RB(4))-ABS(RA(4)))+ABS(ABS(RB(3))-ABS(RA(3)))+ABS(ABS(RB(2))-ABS(RA(2)))+ABS(ABS(RB(1))-ABS(RA(1)))
IF(YS_FLAG(2).EQ.0.AND.YS_FLAG(3).EQ.1)THEN
    DO K=1,100
    RS0=(K-1)*1.0+1.0
    DO J=MAX(1,INT(RTU-1)),INT(RTD+1)
    RT0=J*1.0
    DO I=1,MDB
    DTB0=(I-1)*0.01
!    CALL AziTrakFM(DIP0,RS0,RT0,DTB0,RA)
    CALL BD_BHCS(DIP0,RS0,RT0,DTB0,RA,CSZ_TEMP)
!!层厚不变，靠近上边界
!IF(DTB0.LE.(CSZ_TEMP(3)-CSZ_TEMP(2))/2.0)THEN
!CALL DOUBLE_BD_AziTrakFM(RS0,RT0,CSZ_TEMP(6),DTB0,CSZ_TEMP(3),DIP0,LAMT0,RA0,SIGNAL0)
!ELSE
!!层厚不变，靠近下边界
!CALL DOUBLE_BD_AziTrakFM(CSZ_TEMP(4),RT0,RS0,CSZ_TEMP(2),DTB0,DIP0,LAMT0,RA0,SIGNAL0)
!ENDIF
!RA(1:4)=RA0(1:4)
!RA(5)=SIGNAL0(1)


    ERR1=ABS(ABS(RB(5))-ABS(RA(5)))+ABS(ABS(RB(4))-ABS(RA(4)))+ABS(ABS(RB(3))-ABS(RA(3)))+ABS(ABS(RB(2))-ABS(RA(2)))+ABS(ABS(RB(1))-ABS(RA(1)))
    IF(ERR1.le.ERR0-1.0E-5)THEN
    ERR0=ERR1
    RES_FY(1)=DIP0
    RES_FY(2)=RS0
    RES_FY(3)=RT0
    RES_FY(4)=DTB0
    IF(ERR0.LE.1.0E-6)THEN
    GOTO 110
    EXIT
    ENDIF
    ENDIF
    ENDDO
    ENDDO
    ENDDO
ELSEIF(YS_FLAG(2).EQ.1.AND.YS_FLAG(3).EQ.0)THEN
    DO K=MAX(1,INT(RSU-1)),INT(RSD+1)
    RS0=(K)*1.0
    DO J=1,100
    RT0=J*1.0
    DO I=1,MDB
    DTB0=(I-1)*0.01
!    CALL AziTrakFM(DIP0,RS0,RT0,DTB0,RA)
    CALL BD_BHCS(DIP0,RS0,RT0,DTB0,RA,CSZ_TEMP)
!!层厚不变，靠近上边界
!IF(DTB0.LE.(CSZ_TEMP(3)-CSZ_TEMP(2))/2.0)THEN
!CALL DOUBLE_BD_AziTrakFM(RS0,RT0,CSZ_TEMP(6),DTB0,CSZ_TEMP(3),DIP0,LAMT0,RA0,SIGNAL0)
!ELSE
!!层厚不变，靠近下边界
!CALL DOUBLE_BD_AziTrakFM(CSZ_TEMP(4),RT0,RS0,CSZ_TEMP(2),DTB0,DIP0,LAMT0,RA0,SIGNAL0)
!ENDIF
!RA(1:4)=RA0(1:4)
!RA(5)=SIGNAL0(1)



    ERR1=ABS(ABS(RB(5))-ABS(RA(5)))+ABS(ABS(RB(4))-ABS(RA(4)))+ABS(ABS(RB(3))-ABS(RA(3)))+ABS(ABS(RB(2))-ABS(RA(2)))+ABS(ABS(RB(1))-ABS(RA(1)))
    IF(ERR1.le.ERR0-1.0E-5)THEN
    ERR0=ERR1
    RES_FY(1)=DIP0
    RES_FY(2)=RS0
    RES_FY(3)=RT0
    RES_FY(4)=DTB0
    IF(ERR0.LE.1.0E-6)THEN
    GOTO 110
    EXIT
    ENDIF
    ENDIF
    ENDDO
    ENDDO
    ENDDO
ELSEIF(YS_FLAG(2).EQ.1.AND.YS_FLAG(3).EQ.1)THEN
    DO K=MAX(1,INT(MIN(RSU,RTU))-1),INT(MAX(RSD,RTD)+1)
    RS0=(K)*1.0
    DO J=MAX(1,INT(MIN(RSU,RTU))-1),INT(MAX(RSD,RTD)+1)
    RT0=J*1.0
    DO I=1,MDB
    DTB0=(I-1)*0.01
!    CALL AziTrakFM(DIP0,RS0,RT0,DTB0,RA)
    CALL BD_BHCS(DIP0,RS0,RT0,DTB0,RA,CSZ_TEMP)
!!层厚不变，靠近上边界
!IF(DTB0.LE.(CSZ_TEMP(3)-CSZ_TEMP(2))/2.0)THEN
!CALL DOUBLE_BD_AziTrakFM(RS0,RT0,CSZ_TEMP(6),DTB0,CSZ_TEMP(3),DIP0,LAMT0,RA0,SIGNAL0)
!ELSE
!!层厚不变，靠近下边界
!CALL DOUBLE_BD_AziTrakFM(CSZ_TEMP(4),RT0,RS0,CSZ_TEMP(2),DTB0,DIP0,LAMT0,RA0,SIGNAL0)
!ENDIF
!RA(1:4)=RA0(1:4)
!RA(5)=SIGNAL0(1)


    ERR1=ABS(ABS(RB(5))-ABS(RA(5)))+ABS(ABS(RB(4))-ABS(RA(4)))+ABS(ABS(RB(3))-ABS(RA(3)))+ABS(ABS(RB(2))-ABS(RA(2)))+ABS(ABS(RB(1))-ABS(RA(1)))
    IF(ERR1.le.ERR0-1.0E-5)THEN
    ERR0=ERR1
    RES_FY(1)=DIP0
    RES_FY(2)=RS0
    RES_FY(3)=RT0
    RES_FY(4)=DTB0
    IF(ERR0.LE.1.0E-6)THEN
    GOTO 110
    EXIT
    ENDIF
    ENDIF
    ENDDO
    ENDDO
    ENDDO
ELSE
    !低阻围岩
    DO K=1,50
    RS0=K*1.0 !CSZ_TEMP(K)
    DO J=1,100
    RT0=J*1.0 !CSZ_TEMP(J)
    DO I=1,MDB
    DTB0=(I-1)*0.01
!    CALL AziTrakFM(DIP0,RS0,RT0,DTB0,RA)
    CALL BD_BHCS(DIP0,RS0,RT0,DTB0,RA,CSZ_TEMP)
!!层厚不变，靠近上边界
!IF(DTB0.LE.(CSZ_TEMP(3)-CSZ_TEMP(2))/2.0)THEN
!CALL DOUBLE_BD_AziTrakFM(RS0,RT0,CSZ_TEMP(6),DTB0,CSZ_TEMP(3),DIP0,LAMT0,RA0,SIGNAL0)
!ELSE
!!层厚不变，靠近下边界
!CALL DOUBLE_BD_AziTrakFM(CSZ_TEMP(4),RT0,RS0,CSZ_TEMP(2),DTB0,DIP0,LAMT0,RA0,SIGNAL0)
!ENDIF
!RA(1:4)=RA0(1:4)
!RA(5)=SIGNAL0(1)


    ERR1=ABS(ABS(RB(5))-ABS(RA(5)))+ABS(ABS(RB(4))-ABS(RA(4)))+ABS(ABS(RB(3))-ABS(RA(3)))+ABS(ABS(RB(2))-ABS(RA(2)))+ABS(ABS(RB(1))-ABS(RA(1)))
    IF(ERR1.le.ERR0-1.0E-5)THEN
    ERR0=ERR1
    RES_FY(1)=DIP0
    RES_FY(2)=RS0
    RES_FY(3)=RT0
    RES_FY(4)=DTB0
    IF(ERR0.LE.1.0E-6)THEN
    GOTO 110
    EXIT
    ENDIF
    ENDIF
    ENDDO
    ENDDO
    ENDDO
    !!!!高阻围岩
    DO K=1,10
    RS0=50+K*5.0 !CSZ_TEMP(K)
    DO J=1,100
    RT0=J*1.0 !CSZ_TEMP(J)
    DO I=1,MDB
    DTB0=(I-1)*0.01
!    CALL AziTrakFM(DIP0,RS0,RT0,DTB0,RA)
    CALL BD_BHCS(DIP0,RS0,RT0,DTB0,RA,CSZ_TEMP)
!!层厚不变，靠近上边界
!IF(DTB0.LE.(CSZ_TEMP(3)-CSZ_TEMP(2))/2.0)THEN
!CALL DOUBLE_BD_AziTrakFM(RS0,RT0,CSZ_TEMP(6),DTB0,CSZ_TEMP(3),DIP0,LAMT0,RA0,SIGNAL0)
!ELSE
!!层厚不变，靠近下边界
!CALL DOUBLE_BD_AziTrakFM(CSZ_TEMP(4),RT0,RS0,CSZ_TEMP(2),DTB0,DIP0,LAMT0,RA0,SIGNAL0)
!ENDIF
!RA(1:4)=RA0(1:4)
!RA(5)=SIGNAL0(1)


    ERR1=ABS(ABS(RB(5))-ABS(RA(5)))+ABS(ABS(RB(4))-ABS(RA(4)))+ABS(ABS(RB(3))-ABS(RA(3)))+ABS(ABS(RB(2))-ABS(RA(2)))+ABS(ABS(RB(1))-ABS(RA(1)))
    IF(ERR1.le.ERR0-1.0E-5)THEN
    ERR0=ERR1
    RES_FY(1)=DIP0
    RES_FY(2)=RS0
    RES_FY(3)=RT0
    RES_FY(4)=DTB0
    IF(ERR0.LE.1.0E-6)THEN
    GOTO 110
    EXIT
    ENDIF
    ENDIF
    ENDDO
    ENDDO
    ENDDO
ENDIF

110 RETURN
END



SUBROUTINE GEO_SURFACE(MD,TVD,RES,MPOINT,CDTB,DTB,RTH)
IMPLICIT NONE
INTEGER MPOINT
REAL*8 MD(MPOINT),TVD(MPOINT),RES(MPOINT,5)
REAL*8 DTB(MPOINT,2),RTH(MPOINT,3),CDTB(MPOINT,2)
INTEGER I,J,K
REAL*8 TEMP
INTEGER FLAG,NUM

DTB=0.0
RTH=0.0

!根据初始模型判断起始点层位
IF(CDTB(1,1).GE.0.0.AND.CDTB(1,2).GT.0.0)THEN
FLAG=1
ELSEIF(CDTB(1,1).LT.0.0.AND.CDTB(1,2).GE.0.0)THEN
FLAG=2
ELSE
FLAG=3
ENDIF

DO I=1,MPOINT
IF(FLAG.EQ.1)THEN
    IF(RES(I,5).GE.5.0.AND.RES(I,5).LE.12.0)THEN  !下边界
    
    ELSE !上边界
    
    ENDIF
ELSEIF(FLAG.EQ.2)THEN

ELSE

ENDIF
ENDDO
END





SUBROUTINE INV_AziTrack_LWD_CW(RB,CSZ,RES_RT,RES_FY,ERR0,YS_FLAG,UP_YS,DW_YU,CSZ_TEMP)  !CSZ_TEMP：dip,dtbu,dtbd,rsu,rt,rsd
IMPLICIT NONE
REAL*8 RB(5)
REAL*8 CSZ(6),RES_FY(6),RES_RT(4)
REAL*8 RA(5)
REAL*8 DIP0,RS0,RT0,DTB0
REAL*8 DIPU,DIPD
REAL*8 RSU,RSD,RSU1,RSD1
REAL*8 RTU,RTD
REAL*8 DTBU,DTBD,DTBU1,DTBD1
INTEGER MDIP,MRS,MRT,MDB
INTEGER I,J,K,M,N,I1
REAL*8 ERR0,ERR1,ERRA,ERRS
INTEGER YS_FLAG(6),YSs_FLAG(6),YSe_FLAG(6)
REAL*8 UP_YS(6),DW_YU(6)
REAL*8 YSZ(6),CSZ_TEMP(6)
REAL*8 TIM1,TIM2
REAL*8 RA2RT
REAL*8 GEO(2)
REAL*8 MAX_CZ,MIN_CZ,RAD(4),MIN_RA,MAX_RAS,AVER_RA
REAL*8 RA0(4),SIGNAL0(2),LAMT0,DTB1,RS1

RAD(1:4)=RB(1:4)
DIPU=CSZ(1)
DIPD=CSZ(1)
!DIPU=85.0  
!!!无约束情况下查库范围自动识别
RSU=MAX(MIN(RB(4),RB(2))/2.0-5.0,1.0)
IF(RAD(1).GE.1.2*RAD(4).AND.RAD(1).GE.1.2*RAD(2))THEN !高阻围岩
RSD=MIN(RB(2),RB(4))*0.8
ELSE
RSD=MAX(RB(1),RB(3))+5.0
ENDIF
RSD=MAX(RSU,RSD)
RTU=MAX(RB(3)-10.0,min(min(RB(2),RB(4)),rb(3))*0.8)
RTD=MAX(RB(2)+30.0,min((RB(1)+RB(2))/2.0,min(rb(2),RB(4))*6.0)+abs(RB(3)-RB(1))/1.0)
RTD=MAX(RTU,RTD)
DTBU=0.0
DTBD=6.0

!约束修改为：上围岩、目的层、下围岩、上边界距离、下边界距离、地层方位，按绝对值约束
IF(YS_FLAG(1).EQ.1)THEN !上围岩约束
RSU=UP_YS(1)
RSD=DW_YU(1)
ENDIF
IF(YS_FLAG(2).EQ.1)THEN !目的层电阻率
RTU=UP_YS(2)
RTD=DW_YU(2)
ENDIF
IF(YS_FLAG(3).EQ.1)THEN !下围岩约束
RSU1=UP_YS(3)
RSD1=DW_YU(3)
ENDIF
IF(YS_FLAG(4).EQ.1)THEN !上边界距离
DTBU=UP_YS(4)
DTBD=DW_YU(4)
ENDIF
IF(YS_FLAG(5).EQ.1)THEN !下边界距离
DTBU1=UP_YS(5)
DTBD1=DW_YU(5)
ENDIF
!IF(YS_FLAG(6).EQ.1)THEN !方位约束
!IF(RB(5).LE.UP_YS(6))RB(5)=UP_YS(6)
!IF(RB(5).GE.DW_YU(6))RB(5)=DW_YU(6)
!ENDIF


!IF(YS_FLAG(1).EQ.1)THEN !倾角约束
!DIPU=UP_YS(1)
!DIPD=DW_YU(1)
!ENDIF
!IF(YS_FLAG(6).EQ.1)THEN !各项异性约束
!ENDIF


MDIP=1
MRS=MAX(MIN(100,INT(RSD-RSU)),1)+1
MRT=MAX(MIN(100,INT(RTD-RTU)),1)+1
MDB=601

!PRINT*,YS_FLAG(2)
!PRINT*,YS_FLAG(3)
!PAUSE

CALL BD_BHC(CSZ(1),CSZ(4),CSZ(5),CSZ(6),CSZ(2),CSZ(3),RA)
!PRINT*,RA
!PRINT*,' '
!PRINT*,RB
ERR1=ABS(ABS(RA(5))-ABS(RB(5)))
ERRS=ABS(ABS(RA(1))-ABS(RB(1)))+ABS(ABS(RA(3))-ABS(RB(3)))+ABS(ABS(RA(2))-ABS(RB(2)))+ABS(ABS(RA(4))-ABS(RB(4)))
IF(ERRS.LE.1.0.AND.ERR1.LE.1.0)THEN
RES_FY(1)=CSZ(1)
RES_FY(2)=0.0-ABS(CSZ(2))
RES_FY(3)=CSZ(3)
RES_FY(4)=CSZ(4)
RES_FY(5)=CSZ(5)
RES_FY(6)=CSZ(6)
IF(ABS(CSZ(2)).LE.ABS(CSZ(3)))THEN
RES_RT(2)=CSZ(4)
ELSE
RES_RT(2)=CSZ(6)
ENDIF
RES_RT(3)=CSZ(5)
RES_RT(4)=MIN(ABS(CSZ(2)),ABS(CSZ(3)))
GOTO 120
ELSE
DIP0=CSZ(1)
ERR0=100000.0
ERRA=100000.0
!PRINT*,CSZ(3)-CSZ(2)
DO I=1,5
RS1=MAX(CSZ(4)+I-2.0,1.0)
DO J=1,5
RT0=MAX(CSZ(5)+J-2.0,1.0)
DO K=1,5
RS0=MAX(CSZ(6)+K-2.0,1.0)
DO I1=1,200
DTB0=CSZ(2)+(I1-101)*0.01
DTB1=CSZ(3)-CSZ(2)+DTB0
!IF(DTB1.LE.2.0)CYCLE
CALL BD_BHC(DIP0,RS1,RT0,RS0,DTB0,DTB1,RA)
ERR1=ABS(ABS(RA(5))-ABS(RB(5)))
ERRS=ABS(ABS(RA(1))-ABS(RB(1)))+ABS(ABS(RA(3))-ABS(RB(3)))+ABS(ABS(RA(2))-ABS(RB(2)))+ABS(ABS(RA(4))-ABS(RB(4)))
IF(ERR1.LE.ERR0.AND.ERRS.LE.3.0*ERRA)THEN
ERR0=ERR1
IF(ERRS.LE.ERRA)ERRS=ERRA
RES_FY(1)=DIP0
RES_FY(2)=0.0-ABS(DTB0)
RES_FY(3)=DTB1
RES_FY(4)=CSZ(4)
RES_FY(5)=RT0
RES_FY(6)=CSZ(6)
RES_RT(2)=RS0
RES_RT(3)=RT0
RES_RT(4)=MIN(ABS(DTB0),ABS(DTB1))
ENDIF

DTB1=CSZ(3)+(I1-100)*0.01
DTB0=DTB1-CSZ(3)-CSZ(2)
!IF(DTB1.LE.2.0)CYCLE
CALL BD_BHC(DIP0,RS1,RT0,RS0,DTB0,DTB1,RA)
ERR1=ABS(ABS(RA(5))-ABS(RB(5)))
ERRS=ABS(ABS(RA(1))-ABS(RB(1)))+ABS(ABS(RA(3))-ABS(RB(3)))+ABS(ABS(RA(2))-ABS(RB(2)))+ABS(ABS(RA(4))-ABS(RB(4)))
IF(ERR1.LE.ERR0.AND.ERRS.LE.5.0*ERRA)THEN
ERR0=ERR1
IF(ERRS.LE.ERRA)ERRA=ERRS
RES_FY(1)=DIP0
RES_FY(2)=0.0-ABS(DTB0)
RES_FY(3)=DTB1
RES_FY(4)=CSZ(4)
RES_FY(5)=RT0
RES_FY(6)=CSZ(6)
RES_RT(2)=RS0
RES_RT(3)=RT0
RES_RT(4)=MIN(ABS(DTB0),ABS(DTB1))
ENDIF
IF(ERRS.LE.0.05*(RB(1)+RB(2)+RB(3))/3.0)GOTO 120
ENDDO
ENDDO
ENDDO
ENDDO
ENDIF


!IF(YS_FLAG(1).EQ.1.AND.YS_FLAG(2).EQ.1.AND.YS_FLAG(3).EQ.1)THEN
DIP0=CSZ(1)
!ERR0=100000.0
!ERRA=100000.0
RS0=CSZ(4)
RS1=CSZ(6)
RT0=CSZ(5)
DO K=1,MDB/2-50
DTB0=0.0-(K-1)*0.02
DO I=1,MDB/2-50
DTB1=(I-1)*0.02
CALL BD_BHC(DIP0,RS1,RT0,RS0,DTB0,DTB1,RA)
ERR1=ABS(ABS(RA(5))-ABS(RB(5)))
ERRS=ABS(ABS(RA(1))-ABS(RB(1)))+ABS(ABS(RA(3))-ABS(RB(3)))+ABS(ABS(RA(2))-ABS(RB(2)))+ABS(ABS(RA(4))-ABS(RB(4)))
IF(ERR1.LE.ERR0.AND.ERRS.LE.5.0*ERRA)THEN
ERR0=ERR1
IF(ERRS.LE.ERRA)ERRA=ERRS
RES_FY(1)=DIP0
RES_FY(2)=0.0-ABS(DTB0)
RES_FY(3)=DTB1
RES_FY(4)=CSZ(4)
RES_FY(5)=RT0
RES_FY(6)=CSZ(6)
RES_RT(2)=RS0
RES_RT(3)=RT0
RES_RT(4)=MIN(ABS(DTB0),ABS(DTB1))
IF(ERRS.LE.0.05*(RB(1)+RB(2)+RB(3))/3.0)GOTO 120
ENDIF
ENDDO
ENDDO
!GOTO 120
!ENDIF  


IF(YS_FLAG(1).EQ.1.AND.YS_FLAG(2).EQ.1.AND.YS_FLAG(3).EQ.1)THEN
DIP0=CSZ(1)
!ERR0=100000.0
!ERRA=100000.0
DO I=1,MRS
RS0=(I-1)+RSU
!DO I1=1,1 !MRS
RS1=RS0 !(I1-1)+RSU1
DO J=1,MRT
RT0=(J-1)+RTU
DO K=1,MDB-100
DTB0=(K-1)*0.01
DTB1=6.0
!PRINT*,CSZ
!PRINT*,DIP0,RS1,RT0,RS0,DTB0,DTB1

CALL BD_BHC(DIP0,RS1,RT0,RS0,DTB0,DTB1,RA)
ERR1=ABS(ABS(RA(5))-ABS(RB(5)))
ERRS=ABS(ABS(RA(1))-ABS(RB(1)))+ABS(ABS(RA(3))-ABS(RB(3)))+ABS(ABS(RA(2))-ABS(RB(2)))+ABS(ABS(RA(4))-ABS(RB(4)))
IF(ERRS+ERR1.LE.(ERRA+ERR0)*1.2)THEN
IF(ERR1.LE.ERR0)THEN
ERR0=ERR1
IF(ERRS.LE.ERRA)ERRA=ERRS
RES_FY(1)=DIP0
RES_FY(2)=DTB0
RES_FY(3)=DTB1
RES_FY(4)=CSZ(4)
RES_FY(5)=RT0
RES_FY(6)=CSZ(6)
RES_RT(2)=RS0
RES_RT(3)=RT0
RES_RT(4)=DTB0
ENDIF
ENDIF
ENDDO
!ENDDO
ENDDO
ENDDO
GOTO 110
ENDIF  
!!!!!!!****************************!!!!!!!!!!
     YSS_FLAG=YS_FLAG
     YSe_FLAG=YS_FLAG
     IF(YS_FLAG(3).EQ.0)THEN !目的层无约束情况
     YSS_FLAG(3)=1
     UP_YS(3)=MIN(RA2RT(RAD,GEO)*0.85,CSZ(5))
     DW_YU(3)=MAX(RA2RT(RAD,GEO)*1.55,CSZ(5))
     ELSE
     ENDIF
     MIN_CZ=MIN(MIN(CSZ_TEMP(4),CSZ_TEMP(5)),CSZ_TEMP(6))
     MAX_CZ=MAX(MAX(CSZ_TEMP(4),CSZ_TEMP(5)),CSZ_TEMP(6))
     MIN_CZ=MIN(MIN_CZ,0.2*RA2RT(RAD,GEO))
     MAX_CZ=MAX(MAX_CZ,5.0*RA2RT(RAD,GEO))
     IF(YSS_FLAG(2).EQ.0)THEN !围岩无约束情况
     YS_FLAG(2)=1
     IF(RA2RT(RAD,GEO).LE.MIN_CZ)THEN
     UP_YS(2)=MIN(MAX_CZ*1.05,MIN(CSZ(4),CSZ(6)))
     DW_YU(2)=MAX(MAX_CZ*1.25,MAX(CSZ(4),CSZ(6)))
     ELSE
     UP_YS(2)=MIN(MIN_CZ*1.05,MIN(CSZ(4),CSZ(6)))
     DW_YU(2)=MAX(MIN_CZ*1.25,MAX(CSZ(4),CSZ(6)))
     ENDIF
     ENDIF

     DO I=1,4
     IF(RAD(I).LE.0.2.OR.RAD(I).GE.300.0)THEN
     RAD(I)=RA2RT(RAD,GEO)
     ENDIF
     ENDDO
     !GR泥岩约束
     IF(RA2RT(RAD,GEO).LE.1.0)THEN  !泥岩
     UP_YS(2)=RA2RT(RAD,GEO)*5.0
     DW_YU(2)=RA2RT(RAD,GEO)*10.0
     ENDIF

!IF(YS_FLAG(1).EQ.1)THEN !倾角约束
!DIPU=UP_YS(1)
!DIPD=DW_YU(1)
!ENDIF
!IF(YSS_FLAG(2).EQ.1)THEN !围岩约束
!RSU=UP_YS(2)
!RSD=DW_YU(2)
!ENDIF
!IF(YSS_FLAG(3).EQ.1)THEN !目的层电阻率
!RTU=UP_YS(3)
!RTD=DW_YU(3)
!ENDIF
!IF(YS_FLAG(4).EQ.1)THEN !边界距离
!DTBU=UP_YS(4)
!DTBD=DW_YU(4)
!ENDIF
!IF(YS_FLAG(5).EQ.1)THEN !方位约束
!DTBU=UP_YS(5)
!DTBD=DW_YU(5)
!ENDIF
!IF(YS_FLAG(6).EQ.1)THEN !各项异性约束
!ENDIF
!约束修改为：上围岩、目的层、下围岩、上边界距离、下边界距离、地层方位，按绝对值约束
IF(YS_FLAG(1).EQ.1)THEN !上围岩约束
RSU=UP_YS(1)
RSD=DW_YU(1)
ENDIF
IF(YS_FLAG(2).EQ.1)THEN !目的层电阻率
RTU=UP_YS(2)
RTD=DW_YU(2)
ENDIF
IF(YS_FLAG(3).EQ.1)THEN !下围岩约束
RSU1=UP_YS(3)
RSD1=DW_YU(3)
ENDIF
IF(YS_FLAG(4).EQ.1)THEN !上边界距离
DTBU=UP_YS(4)
DTBD=DW_YU(4)
ENDIF
IF(YS_FLAG(5).EQ.1)THEN !下边界距离
DTBU1=UP_YS(5)
DTBD1=DW_YU(5)
ENDIF
!IF(YS_FLAG(6).EQ.1)THEN !方位约束
!IF(RB(5).LE.UP_YS(6))RB(5)=UP_YS(6)
!IF(RB(5).GE.DW_YU(6))RB(5)=UP_YS(6)
!ENDIF




MDIP=1
MRS=MAX(MIN(100,INT(RSD-RSU)),1)+1
MRT=MAX(MIN(100,INT(RTD-RTU)),1)+1
MDB=601
!!!!!!************************************!!!!!!!


!CALL CPU_TIME(TIM1) !记录反演开始时间
!全参数反演，获取初值
ERR0=1E+12
ERRA=1E+12
DO M=1,MDIP
DIP0=DIPU+(M-1)*(DIPD-DIPU)/(MDIP)
DO K=1,MRS
RS0=RSU+(K-1) !*(INT(RSD-RSU))/(MRS)
!RS0=K
DO J=1,MRT+1
RT0=RTU+(J-1) !*(INT(RTD-RTU))/(MRT)
!RT0=J
DO I=1,MDB/10 
DTB0=(I-1)*0.1

DTB1=ABS(CSZ(3))+ABS(CSZ(2))-DTB0
IF(DTB1.LT.0.0)CYCLE
IF(DTB0.LE.DTB1)THEN
RS1=CSZ(6)
CALL BD_BHC(DIP0,RS0,RT0,RS1,DTB0,DTB1,RA)
ELSE
RS1=CSZ(4)
CALL BD_BHC(DIP0,RS1,RT0,RS0,DTB0,DTB1,RA)
ENDIF

!CALL BD_BHC(DIP0,RS0,RT0,DTB0,RA,CSZ_TEMP)
!!层厚不变，靠近上边界
!IF(DTB0.LE.(CSZ_TEMP(3)-CSZ_TEMP(2))/2.0)THEN
!CALL DOUBLE_BD_AziTrakFM(RS0,RT0,CSZ_TEMP(6),DTB0,CSZ_TEMP(3),DIP0,LAMT0,RA0,SIGNAL0)
!ELSE
!!层厚不变，靠近下边界
!CALL DOUBLE_BD_AziTrakFM(CSZ_TEMP(4),RT0,RS0,CSZ_TEMP(2),DTB0,DIP0,LAMT0,RA0,SIGNAL0)
!ENDIF
!RA(1:4)=RA0(1:4)
!RA(5)=SIGNAL0(1)


ERR1=0.0
ERRS=0.0
DO N=1,4
IF(RB(N).LE.5000.0.AND.RB(N).GE.0.5)THEN
ERRS=ERRS+ABS(RB(N)-RA(N))
ENDIF
ENDDO
!ERR1=ABS(ABS(RB(5))-ABS(RA(5)))
IF(ERRS.le.ERRA-1.0E-5)THEN
ERR0=ERR1
ERRA=ERRS
RES_FY(1)=DIP0
RES_FY(2)=DTB0
RES_FY(3)=DTB1
RES_FY(4)=RS0 
RES_FY(5)=RT0
RES_FY(6)=CSZ(6) 

IF(ERRA.LE.1.0E-6)EXIT
ENDIF

ENDDO
ENDDO
ENDDO
ENDDO


!边界距离反演
!ERR0=1E+12
!DIP0=85.0
!ERRA=1E+12
DIP0=CSZ(1)
RS0=RES_FY(4)
RT0=(RES_FY(5)+CSZ(5)*5.0)/6.0
!add 2023.3.10
RT0=min(RB(1),min(rb(2),RB(4))*10.0)+(RB(3)-RB(1))/3.0

RS1=RES_FY(6)
DO I=1,MDB/10 
DTB0=(I-1)*0.1

DTB1=ABS(CSZ(3))+ABS(CSZ(2))-DTB0
IF(DTB1.LT.0.0)CYCLE
IF(DTB0.LE.DTB1)THEN
RS1=CSZ(6)
CALL BD_BHC(DIP0,RS0,RT0,RS1,DTB0,DTB1,RA)
ELSE
RS1=CSZ(4)
CALL BD_BHC(DIP0,RS1,RT0,RS0,DTB0,DTB1,RA)
ENDIF

!CALL BD_BHC(DIP0,RS0,RT0,DTB0,RA,CSZ_TEMP)
!层厚不变，靠近上边界
!IF(DTB0.LE.(CSZ_TEMP(3)-CSZ_TEMP(2))/2.0)THEN
!CALL DOUBLE_BD_AziTrakFM(RS0,RT0,CSZ_TEMP(6),DTB0,CSZ_TEMP(3),DIP0,LAMT0,RA0,SIGNAL0)
!ELSE
!!层厚不变，靠近下边界
!CALL DOUBLE_BD_AziTrakFM(CSZ_TEMP(4),RT0,RS0,CSZ_TEMP(2),DTB0,DIP0,LAMT0,RA0,SIGNAL0)
!ENDIF
!RA(1:4)=RA0(1:4)
!RA(5)=SIGNAL0(1)

ERR1=ABS(ABS(RB(5))-ABS(RA(5)))
ERRS=ABS(ABS(RA(1))-ABS(RB(1)))+ABS(ABS(RA(3))-ABS(RB(3)))
IF(ERR1.LE.ERR0.AND.ERRS.LE.3.0*ERRA)THEN
ERR0=ERR1
IF(ERRS.LE.ERRA)ERRA=ERRS
RES_FY(2)=DTB0
RES_FY(3)=DTB1
IF(ERR0.LE.1.0E-6)EXIT
ENDIF
ENDDO



!!RT反演电阻率
!!ERR0=1E+12
!DIP0=85.0
!ERRA=1E+12
DIP0=CSZ(1)
DTB0=RES_FY(2)
DTB1=RES_FY(3)
RS0=RES_FY(4)
RS1=RES_FY(6)
!DO K=1,MRS
!RS0=RSU+(K-1) !*(INT(RSD-RSU))/(MRS)
!RS0=K
DO J=1,MRT+1
RT0=RTU+(J-1) !*(INT(RTD-RTU))/(MRT)
!围岩-目的层
CALL BD_BHC(DIP0,RS0,RT0,RS1,DTB0,DTB1,RA)
!CALL BD_BHC(DIP0,RS0,RT0,DTB0,RA,CSZ_TEMP)
!!层厚不变，靠近上边界
!IF(DTB0.LE.(CSZ_TEMP(3)-CSZ_TEMP(2))/2.0)THEN
!CALL DOUBLE_BD_AziTrakFM(RS0,RT0,CSZ_TEMP(6),DTB0,CSZ_TEMP(3),DIP0,LAMT0,RA0,SIGNAL0)
!ELSE
!!层厚不变，靠近下边界
!CALL DOUBLE_BD_AziTrakFM(CSZ_TEMP(4),RT0,RS0,CSZ_TEMP(2),DTB0,DIP0,LAMT0,RA0,SIGNAL0)
!ENDIF
!RA(1:4)=RA0(1:4)
!RA(5)=SIGNAL0(1)


ERR1=0.0
ERRS=0.0
DO N=1,4
IF(RB(N).LE.200.0.AND.RB(N).GE.0.5)THEN
ERRS=ERRS+ABS(RB(N)-RA(N))
ENDIF
ENDDO
ERR1=ABS(ABS(RB(5))-ABS(RA(5)))
IF(ERRS.le.ERRA-1.0E-5.AND.ERR1.LE.ERR0*3.0)THEN
IF(ERR1.LE.ERR0)ERR0=ERR1
ERRA=ERRS
RES_FY(5)=RT0
IF(ERRA.LE.1.0E-6)EXIT
ENDIF
ENDDO
!ENDDO



!DIP0=85.0
!DTB0=RES_FY(4)
!DO K=1,MRS
!RS0=RSU+(K-1) !*(INT(RSD-RSU))/(MRS)
!!RS0=K
!DO J=1,MRT+1
!RT0=RTU+(J-1) !*(INT(RTD-RTU))/(MRT)
!!围岩-目的层
!CALL AziTrakFM(DIP0,RS0,RT0,DTB0,RA)
!ERR1=0.0
!DO N=1,4
!IF(RB(N).LE.5000.0.AND.RB(N).GE.0.5)THEN
!ERR1=ERR1+ABS(RB(N)-RA(N))
!ENDIF
!ENDDO
!ERR1=ERR1+ABS(ABS(RB(5))-ABS(RA(5)))
!IF(ERR1.le.ERR0-1.0E-5)THEN
!ERR0=ERR1
!RES_FY(2)=RS0
!RES_FY(3)=RT0
!IF(ERR0.LE.1.0E-6)EXIT
!ENDIF
!ENDDO
!ENDDO


!边界距离反演
!DIP0=85.0
DIP0=CSZ(1)
!ERRA=1E+12
YS_FLAG=YSe_FLAG

CALL BD_BHC(DIP0,RES_FY(4),RES_FY(5),RES_FY(6),RES_FY(2),RES_FY(3),RA)

!CALL BD_BHC(DIP0,RES_FY(2),RES_FY(3),RES_FY(4),RA,CSZ_TEMP)
!!层厚不变，靠近上边界
!IF(DTB0.LE.(CSZ_TEMP(3)-CSZ_TEMP(2))/2.0)THEN
!CALL DOUBLE_BD_AziTrakFM(RS0,RT0,CSZ_TEMP(6),DTB0,CSZ_TEMP(3),DIP0,LAMT0,RA0,SIGNAL0)
!ELSE
!!层厚不变，靠近下边界
!CALL DOUBLE_BD_AziTrakFM(CSZ_TEMP(4),RT0,RS0,CSZ_TEMP(2),DTB0,DIP0,LAMT0,RA0,SIGNAL0)
!ENDIF
!RA(1:4)=RA0(1:4)
!RA(5)=SIGNAL0(1)




    ERR0=0.0
    ERRA=0.0
    DO N=1,4
    IF(RB(N).GE.0.5.AND.RB(N).LE.200.0)THEN
    ERRA=ERRA+ABS(ABS(RB(N))-ABS(RA(N)))
    ENDIF
    ENDDO
    ERR0=ABS(ABS(RB(5))-ABS(RA(5)))

IF(YS_FLAG(2).EQ.0.AND.YS_FLAG(3).EQ.1)THEN
    DO K=1,MRS
    RS0=(K-1)*1.0+RSU
    DO J=1,MRT
    RT0=J*1.0+RTU
    DO I=1,MDB
    DTB0=(I-1)*0.01

DTB1=ABS(CSZ(3))+ABS(CSZ(2))-DTB0
IF(DTB1.LT.0.0)CYCLE
IF(DTB0.LE.DTB1)THEN
RS1=CSZ(6)
CALL BD_BHC(DIP0,RS0,RT0,RS1,DTB0,DTB1,RA)
ELSE
RS1=CSZ(4)
CALL BD_BHC(DIP0,RS1,RT0,RS0,DTB0,DTB1,RA)
ENDIF

!    CALL BD_BHC(DIP0,RS0,RT0,DTB0,RA,CSZ_TEMP)
!!层厚不变，靠近上边界
!IF(DTB0.LE.(CSZ_TEMP(3)-CSZ_TEMP(2))/2.0)THEN
!CALL DOUBLE_BD_AziTrakFM(RS0,RT0,CSZ_TEMP(6),DTB0,CSZ_TEMP(3),DIP0,LAMT0,RA0,SIGNAL0)
!ELSE
!!层厚不变，靠近下边界
!CALL DOUBLE_BD_AziTrakFM(CSZ_TEMP(4),RT0,RS0,CSZ_TEMP(2),DTB0,DIP0,LAMT0,RA0,SIGNAL0)
!ENDIF
!RA(1:4)=RA0(1:4)
!RA(5)=SIGNAL0(1)


    ERR1=0.0
    ERRS=0.0
    DO N=1,4 
    IF(RB(N).GE.0.5.AND.RB(N).LE.200.0)THEN
    ERRS=ERRS+ABS(ABS(RB(N))-ABS(RA(N)))
    ENDIF
    ENDDO
    ERR1=ABS(ABS(RB(5))-ABS(RA(5)))
    IF(ERRS.le.ERRA*3.0.AND.ERR1.LE.ERR0)THEN
    ERR0=ERR1
    IF(ERRS.LE.ERRA)ERRA=ERRS
RES_FY(1)=DIP0
RES_FY(2)=DTB0
RES_FY(3)=DTB1
RES_FY(4)=RS0
RES_FY(5)=RT0
RES_FY(6)=RS1
    IF(ERRA.LE.1.0E-6)THEN
    GOTO 110
    EXIT
    ENDIF
    ENDIF
    ENDDO
    ENDDO
    ENDDO
ELSEIF(YS_FLAG(2).EQ.1.AND.YS_FLAG(3).EQ.0)THEN
    DO K=1,MRS
    RS0=(K)*1.0+RSU
    DO J=1,MRT !MAX(INT(MIN(MIN(RB(1),RB(2)),RB(3))*0.8)+1,1),min(INT(MAX(MAX(RB(1),RB(2)),RB(3))*3.0)+1,100)
    RT0=J*1.0+RTU
    DO I=1,MDB/5 
    DTB0=(I-1)*0.05

DTB1=ABS(CSZ(3))+ABS(CSZ(2))-DTB0
IF(DTB1.LT.0.0)CYCLE
IF(DTB0.LE.DTB1)THEN
RS1=CSZ(6)
CALL BD_BHC(DIP0,RS0,RT0,RS1,DTB0,DTB1,RA)
ELSE
RS1=CSZ(4)
CALL BD_BHC(DIP0,RS1,RT0,RS0,DTB0,DTB1,RA)
ENDIF

!    CALL BD_BHC(DIP0,RS0,RT0,DTB0,RA,CSZ_TEMP)
!!层厚不变，靠近上边界
!IF(DTB0.LE.(CSZ_TEMP(3)-CSZ_TEMP(2))/2.0)THEN
!CALL DOUBLE_BD_AziTrakFM(RS0,RT0,CSZ_TEMP(6),DTB0,CSZ_TEMP(3),DIP0,LAMT0,RA0,SIGNAL0)
!ELSE
!!层厚不变，靠近下边界
!CALL DOUBLE_BD_AziTrakFM(CSZ_TEMP(4),RT0,RS0,CSZ_TEMP(2),DTB0,DIP0,LAMT0,RA0,SIGNAL0)
!ENDIF
!RA(1:4)=RA0(1:4)
!RA(5)=SIGNAL0(1)



    ERR1=0.0
    ERRS=0.0
    DO N=1,4 
    IF(RB(N).GE.0.5.AND.RB(N).LE.200.0)THEN
    ERRS=ERRS+ABS(ABS(RB(N))-ABS(RA(N)))
    ENDIF
    ENDDO
    ERR1=ABS(ABS(RB(5))-ABS(RA(5)))
    IF(ERRS.LE.ERRA*3.0.AND.ERR1.LE.ERR0)THEN
    ERR0=ERR1
    IF(ERRS.LE.ERRA)ERRA=ERRS
RES_FY(1)=DIP0
RES_FY(2)=DTB0
RES_FY(3)=DTB1
RES_FY(4)=RS0
RES_FY(5)=RT0
RES_FY(6)=RS1
    IF(ERRA.LE.1.0E-6)THEN
    GOTO 110
    EXIT
    ENDIF
    ENDIF
    ENDDO
    ENDDO
    ENDDO
ELSEIF(YS_FLAG(2).EQ.1.AND.YS_FLAG(3).EQ.1)THEN
    DO K=RSU,RSD 
    RS0=(K)*1.0
    DO J= RTU ,RTD 
    RT0=J*1.0
    DO I=1,MDB 
    DTB0=(I-1)*0.01

DTB1=ABS(CSZ(3))+ABS(CSZ(2))-DTB0
IF(DTB1.LT.0.0)CYCLE
IF(DTB0.LE.DTB1)THEN
RS1=CSZ(6)
CALL BD_BHC(DIP0,RS0,RT0,RS1,DTB0,DTB1,RA)
ELSE
RS1=CSZ(4)
CALL BD_BHC(DIP0,RS1,RT0,RS0,DTB0,DTB1,RA)
ENDIF

!    CALL BD_BHC(DIP0,RS0,RT0,DTB0,RA,CSZ_TEMP)
!!层厚不变，靠近上边界
!IF(DTB0.LE.(CSZ_TEMP(3)-CSZ_TEMP(2))/2.0)THEN
!CALL DOUBLE_BD_AziTrakFM(RS0,RT0,CSZ_TEMP(6),DTB0,CSZ_TEMP(3),DIP0,LAMT0,RA0,SIGNAL0)
!ELSE
!!层厚不变，靠近下边界
!CALL DOUBLE_BD_AziTrakFM(CSZ_TEMP(4),RT0,RS0,CSZ_TEMP(2),DTB0,DIP0,LAMT0,RA0,SIGNAL0)
!ENDIF
!RA(1:4)=RA0(1:4)
!RA(5)=SIGNAL0(1)


    ERR1=0.0
    ERRS=0.0
    DO N=1,4 
    IF(RB(N).GE.0.5.AND.RB(N).LE.200.0)THEN
    ERRS=ERRS+ABS(ABS(RB(N))-ABS(RA(N)))
    ENDIF
    ENDDO
!    ERR1=ABS(ABS(RB(5))-ABS(RA(5)))
    IF(ERRS.le.ERRA-1.0E-5.AND.ERR1.LE.ERR0*3.0)THEN
    IF(ERR1.LE.ERR0)ERR0=ERR1
    ERRA=ERRS
RES_FY(1)=DIP0
RES_FY(2)=DTB0
RES_FY(3)=DTB1
RES_FY(4)=CSZ(4)
RES_FY(5)=RT0
RES_FY(6)=CSZ(6)
    IF(ERRA.LE.1.0E-6)THEN
    GOTO 110
    EXIT
    ENDIF
    ENDIF
    ENDDO
    ENDDO
    ENDDO
ELSE
    !低阻围岩
    DO K=1,min(INT(MAX(MAX(RB(1),RB(2)),RB(3))*5.0)+1,50)
    RS0=K*1.0 !CSZ_TEMP(K)
    DO J=1,1 !min(MAX(1,INT(MIN(RB(1),RB(2))*0.8)),k),min(INT(MAX(MAX(RB(1),RB(2)),RB(3))*2.0)+1,50)
!    RT0=J*1.0 !CSZ_TEMP(J)
    RT0=RES_FY(5)
    DO I=1,MDB/10 
    DTB0=(I-1)*0.1

DTB1=ABS(CSZ(3))+ABS(CSZ(2))-DTB0
IF(DTB1.LT.0.0)CYCLE
IF(DTB0.LE.DTB1)THEN
RS1=CSZ(6)
CALL BD_BHC(DIP0,RS0,RT0,RS1,DTB0,DTB1,RA)
ELSE
RS1=CSZ(4)
CALL BD_BHC(DIP0,RS1,RT0,RS0,DTB0,DTB1,RA)
ENDIF

!    CALL BD_BHC(DIP0,RS0,RT0,DTB0,RA,CSZ_TEMP)
!!层厚不变，靠近上边界
!IF(DTB0.LE.(CSZ_TEMP(3)-CSZ_TEMP(2))/2.0)THEN
!CALL DOUBLE_BD_AziTrakFM(RS0,RT0,CSZ_TEMP(6),DTB0,CSZ_TEMP(3),DIP0,LAMT0,RA0,SIGNAL0)
!ELSE
!!层厚不变，靠近下边界
!CALL DOUBLE_BD_AziTrakFM(CSZ_TEMP(4),RT0,RS0,CSZ_TEMP(2),DTB0,DIP0,LAMT0,RA0,SIGNAL0)
!ENDIF
!RA(1:4)=RA0(1:4)
!RA(5)=SIGNAL0(1)

    ERR1=0.0
    ERRS=0.0
    DO N=1,4 
    IF(RB(N).GE.0.5.AND.RB(N).LE.200.0)THEN
    ERRS=ERRS+ABS(ABS(RB(N))-ABS(RA(N)))
    ENDIF
    ENDDO
    ERR1=ABS(ABS(RB(5))-ABS(RA(5)))
    IF(ERRS.le.ERRA-1.0E-5 )THEN
    ERR0=ERR1
    ERRA=ERRS
RES_FY(1)=DIP0
RES_FY(2)=DTB0
RES_FY(3)=DTB1
RES_FY(4)=CSZ(4)
RES_FY(5)=RT0
RES_FY(6)=CSZ(6)
    IF(ERRA.LE.1.0E-6)THEN
    GOTO 110
    EXIT
    ENDIF
    ENDIF
    ENDDO
    ENDDO
    ENDDO
    !!!!高阻围岩
    DO K=min(int(RT0*2),100),max(30,min(int(RT0*2)*5+10,100))
    RS0=RT0+K*2.0 !CSZ_TEMP(K)
    DO J=1,1 !min(int(RT0*2),100)
!    RT0=J*1.0 !CSZ_TEMP(J)
    RT0=RES_FY(5)
    DO I=1,MDB/10 
    DTB0=(I-1)*0.1

DTB1=ABS(CSZ(3))+ABS(CSZ(2))-DTB0
IF(DTB1.LT.0.0)CYCLE
IF(DTB0.LE.DTB1)THEN
RS1=CSZ(6)
CALL BD_BHC(DIP0,RS0,RT0,RS1,DTB0,DTB1,RA)
ELSE
RS1=CSZ(4)
CALL BD_BHC(DIP0,RS1,RT0,RS0,DTB0,DTB1,RA)
ENDIF

!    CALL BD_BHC(DIP0,RS0,RT0,DTB0,RA,CSZ_TEMP)
!!层厚不变，靠近上边界
!IF(DTB0.LE.(CSZ_TEMP(3)-CSZ_TEMP(2))/2.0)THEN
!CALL DOUBLE_BD_AziTrakFM(RS0,RT0,CSZ_TEMP(6),DTB0,CSZ_TEMP(3),DIP0,LAMT0,RA0,SIGNAL0)
!ELSE
!!层厚不变，靠近下边界
!CALL DOUBLE_BD_AziTrakFM(CSZ_TEMP(4),RT0,RS0,CSZ_TEMP(2),DTB0,DIP0,LAMT0,RA0,SIGNAL0)
!ENDIF
!RA(1:4)=RA0(1:4)
!RA(5)=SIGNAL0(1)


    ERR1=0.0
    ERRS=0.0
    DO N=1,4 
    IF(RB(N).GE.0.5.AND.RB(N).LE.200.0)THEN
    ERRS=ERRS+ABS(ABS(RB(N))-ABS(RA(N)))
    ENDIF
    ENDDO
    ERR1=ABS(ABS(RB(5))-ABS(RA(5)))
    IF(ERRS.le.ERRA-1.0E-5)THEN
    ERR0=ERR1
    ERRA=ERRS
RES_FY(1)=DIP0
RES_FY(2)=DTB0
RES_FY(3)=DTB1
RES_FY(4)=CSZ(4)
RES_FY(5)=RT0
RES_FY(6)=CSZ(6)
    IF(ERRA.LE.1.0E-6)THEN
    GOTO 110
    EXIT
    ENDIF
    ENDIF
    ENDDO
    ENDDO
    ENDDO
ENDIF

RES_RT(1)=RES_FY(1)
RES_RT(2)=RES_FY(4)
RES_RT(3)=RES_FY(5)
RES_RT(4)=MIN(ABS(RES_FY(2)),ABS(RES_FY(3)))

CALL BD_BHC(RES_FY(1),RES_FY(4),RES_FY(5),RES_FY(6),RES_FY(2),RES_FY(3),RA)

    ERR0=0.0
    ERRA=0.0
    ERRS=0.0
    ERR1=0.0
    DO N=1,4,2
    IF(RB(N).GE.0.5.AND.RB(N).LE.200.0)THEN
    ERRA=ERRA+ABS(ABS(RB(N))-ABS(RA(N)))
    ENDIF
    ENDDO
    ERR0=ABS(ABS(RB(5))-ABS(RA(5)))

DO K=1,MRS
DO J=1,2
DO I=1,MDB
DTB0=(I-1)*0.01
DTB1=6.0
IF(YS_FLAG(2).EQ.1)THEN
IF(J.EQ.1)THEN
RS0=UP_YS(2)+(K-1)
RS1=UP_YS(2)+(K-1)
RT0=min((RB(1)+RB(3))/2.0,min(rb(2),RB(4))*10.0)+MIN(abs(RB(4)-RB(2))/3.0,MIN_RA(RB)*0.25)
RT0=MAX(RT0,MIN_RA(RB))
CALL BD_BHC(DIP0,RS0,RT0,RS1,DTB0,DTB1,RA)
ELSE
RS0=UP_YS(2)+(K-1)
RS1=UP_YS(2)+(K-1)
RT0=min((RB(1)+RB(3))/2.0,min(rb(2),RB(4))*10.0)+MIN(abs(RB(4)-RB(2))/3.0,MIN_RA(RB)*0.25)
RT0=MAX(RT0,MIN_RA(RB))
CALL BD_BHC(DIP0,RS1,RT0,RS0,DTB0,DTB1,RA)
ENDIF
ELSE
IF(J.EQ.1)THEN
RS0=RSU+(K-1) !MIN(((MAX(1.0,(RB(4)+RB(2))/12.0))),50.0)
RS1=RSU+(K-1) !MIN(((MAX(1.0,(RB(4)+RB(2))/12.0))),50.0)
RT0=min((RB(1)+RB(3))/2.0,min(rb(2),RB(4))*10.0)+MIN(abs(RB(4)-RB(2))/3.0,MIN_RA(RB)*0.25)
RT0=MAX(RT0,MIN_RA(RB))
CALL BD_BHC(DIP0,RS0,RT0,RS1,DTB0,DTB1,RA)
ELSE
RS0=RSU+(K-1) !MIN(((MAX(1.0,(RB(4)+RES_RT(2))/12.0))),50.0)
RS1=RSU+(K-1) !MIN(((MAX(1.0,(RB(4)+RES_RT(2))/12.0))),50.0)
RT0=min((RB(1)+RB(3))/2.0,min(rb(2),RB(4))*10.0)+MIN(abs(RB(4)-RB(2))/3.0,MIN_RA(RB)*0.25)
RT0=MAX(RT0,MIN_RA(RB))
CALL BD_BHC(DIP0,RS1,RT0,RS0,DTB0,DTB1,RA)
ENDIF
ENDIF
ERR1=ABS(ABS(RB(5))-ABS(RA(5))) 
ERRS=ABS(RB(1)-RA(1))+(ABS(RB(2)-RA(2)))
IF(ERR1.le.ERR0-1.0E-5.and.ERRS+err1.LE.(ERRA+err0)*2.2)THEN
ERR0=ERR1
IF(ERRS.LE.ERRA)ERRA=ERRS
RES_RT(1)=DIP0
RES_RT(2)=RS0
RES_RT(3)=RT0
RES_RT(4)=DTB0
IF(ERR0.LE.1.0E-6)THEN
GOTO 110
EXIT
ENDIF
ENDIF
ENDDO
ENDDO
ENDDO

RES_FY(4)=MIN(RES_RT(2),MIN_RA(RB)/3.0)
RES_FY(6)=MIN(RES_RT(2),MIN_RA(RB)/3.0)
RES_FY(5)=(RES_RT(3)+min((RB(1)+RB(3))/2.0,min(rb(2),RB(4))*10.0)+abs(RB(4)-RB(2))*0.8)/2.0
RES_FY(5)=max((MAX_RAS(RB)+AVER_RA(RB))/2.0,RES_FY(5))
RES_FY(5)=(RES_FY(5)+RB(2)+RB(3))/3.0
RES_RT(3)=RES_FY(5)

CALL BD_BHC(DIP0,RES_RT(2),RES_RT(3),RS1,RES_RT(4),DTB1,RA)
ERR0=0.0
ERRS=0.0
DO N=1,4,2
IF(RB(N).GE.0.5.AND.RB(N).LE.200.0)THEN
ERRS=ERRS+ABS(ABS(RB(N))-ABS(RA(N)))
ENDIF
ENDDO
ERR0=ABS(ABS(RB(5))-ABS(RA(5)))

DO K=1,MRS
RS0=RSU+(K-1)
RS1=RS0
RT0=RES_RT(3) 
DIP0=RES_RT(1)
DTB0=RES_RT(4)
DTB1=6.0
CALL BD_BHC(DIP0,RS1,RT0,RS0,DTB0,DTB1,RA)
    ERRS=0.0
    ERR1=0.0
    DO N=1,4
    IF(RB(N).GE.0.5.AND.RB(N).LE.200.0)THEN
    ERRS=ERRS+ABS(ABS(RB(N))-ABS(RA(N)))
    ENDIF
    ENDDO
    ERR1=ABS(ABS(RB(5))-ABS(RA(5)))
IF(ERRS.le.ERRA-1.0E-6.AND.ERR1.LE.5.2*ERR0)THEN
IF(ERR1.LE.ERR0)ERR0=ERR1
ERRA=ERRS
RES_FY(4)=RS0
RES_FY(6)=RS0
RES_RT(2)=RS0
ENDIF
ENDDO

DO K=1,MDB
DTB0=(K-1)*0.01
RS0=RES_RT(2)
RS1=RS0
RT0=RES_RT(3)
DIP0=RES_RT(1)
DTB1=6.0
CALL BD_BHC(DIP0,RS1,RT0,RS0,DTB0,DTB1,RA)
ERR1=ABS(ABS(RB(5))-ABS(RA(5)))
ERRS=ABS(ABS(RB(1))-ABS(RA(1)))+ABS(ABS(RB(3))-ABS(RA(3)))
IF(ERR1.le.ERR0-1.0E-6.and.ERRS+err1.LE.(ERRA+err0)*2.2)THEN
ERR0=ERR1
IF(ERRS.LE.ERRA)ERRA=ERRS
RES_RT(4)=DTB0
ENDIF
ENDDO



110 CONTINUE

RES_FY(1)=RES_RT(1)
RES_FY(4)=RES_RT(2) 
RES_FY(6)=RES_RT(2) 
RES_FY(5)=RES_RT(3) 
RES_FY(2)=RES_RT(4)
RES_FY(3)=RES_RT(4)

120 CONTINUE


END
